<ion-header>
  <ion-toolbar class="modern-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" class="back-button"></ion-back-button>
    </ion-buttons>
    <ion-title class="header-title">Perfil de Usuario</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div *ngIf="loading" class="ion-text-center ion-padding">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando perfil...</p>
  </div>

  <div *ngIf="userNotFound" class="ion-text-center ion-padding">
    <ion-icon name="alert-circle-outline" size="large" color="danger"></ion-icon>
    <p>No se pudo encontrar el usuario.</p>
  </div>

  <div *ngIf="!loading && user">
    <!-- Banner for pending email verification -->
    <ion-card *ngIf="user.pendingEmail" color="warning" class="pending-email-card">
      <ion-card-content class="pending-content">
        <div class="pending-info">
          <ion-icon name="mail-unread" class="pending-icon"></ion-icon>
          <div class="pending-text">
            <strong>Verifica tu nuevo correo:</strong>
            <div class="email-text">{{ user.pendingEmail }}</div>
          </div>
        </div>
        <ion-button size="small" fill="clear" color="warning" (click)="cancelPendingEmail()" class="cancel-btn">
          <ion-icon name="close-circle" slot="start"></ion-icon>
          Cancelar
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Enhanced Profile Header with Cover -->
    <div class="profile-cover-section">
      <div class="cover-background">
        <div class="cover-overlay"></div>
        <div class="floating-elements">
          <div class="float-element float-1">
            <ion-icon name="paw"></ion-icon>
          </div>
          <div class="float-element float-2">
            <ion-icon name="heart"></ion-icon>
          </div>
          <div class="float-element float-3">
            <ion-icon name="star"></ion-icon>
          </div>
        </div>
      </div>
      
      <div class="profile-header-content">
        <div class="avatar-container">
          <ion-avatar class="enhanced-avatar">
            <img [src]="user.profileImageUrl || 'assets/imgs/paw.png'" alt="Foto de perfil" loading="lazy">
          </ion-avatar>
          <div class="verification-badge" *ngIf="user.role === 'organization' || user.role === 'veterinarian'">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
          </div>
          <div class="online-indicator" *ngIf="isUserOnline"></div>
        </div>
        
        <div class="user-info">
          <h1 class="profile-name">{{ user.nombreCompleto }}</h1>
          <div class="user-meta">
            <ion-chip class="role-chip" [color]="getRoleColor(user.role)" *ngIf="user.role">
              <ion-icon [name]="getRoleIcon(user.role)" slot="start"></ion-icon>
              <ion-label>{{ user.role | userRoleTranslate }}</ion-label>
            </ion-chip>
          </div>
          <p class="username">{{ '@' + user.nombreUsuario }}</p>
          <p class="profile-bio" *ngIf="user.bio">{{ user.bio }}</p>
          
          <!-- Join Date -->
          <div class="join-info">
            <ion-icon name="calendar" color="medium"></ion-icon>
            <span>Se unió en {{ getJoinDate(user.createdAt) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- User Statistics -->
    <div class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <ion-icon name="paw" color="primary"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ userStats.petsPublished || 0 }}</div>
            <div class="stat-label">Publicadas</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <ion-icon name="heart" color="success"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ userStats.petsAdopted || 0 }}</div>
            <div class="stat-label">Adoptadas</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Contact Card -->
    <div class="contact-section">
      <h2 class="section-title">
        <ion-icon name="chatbubbles" color="primary"></ion-icon>
        Información de Contacto
      </h2>
      
      <div class="contact-card">
        <div class="contact-actions">
          <!-- Quick Action Buttons -->
          <ion-button 
            *ngIf="user.telefono" 
            class="contact-btn whatsapp-btn"
            (click)="openWhatsApp()"
            expand="block">
            <ion-icon name="logo-whatsapp" slot="start"></ion-icon>
            WhatsApp
          </ion-button>
          
          <ion-button 
            *ngIf="user.email" 
            class="contact-btn email-btn"
            (click)="sendEmail()"
            expand="block"
            fill="outline">
            <ion-icon name="mail" slot="start"></ion-icon>
            Email
          </ion-button>
          
          <ion-button 
            *ngIf="user.telefono" 
            class="contact-btn call-btn"
            (click)="makeCall()"
            expand="block"
            fill="outline">
            <ion-icon name="call" slot="start"></ion-icon>
            Llamar
          </ion-button>
        </div>

        <!-- Contact Details -->
        <div class="contact-details">
          <div class="contact-item" *ngIf="user.email && showContactDetails">
            <ion-icon name="mail" color="primary"></ion-icon>
            <div class="contact-info">
              <div class="contact-label">Email</div>
              <div class="contact-value">{{ user.email }}</div>
            </div>
          </div>
          
          <div class="contact-item" *ngIf="user.telefono && showContactDetails">
            <ion-icon name="call" color="primary"></ion-icon>
            <div class="contact-info">
              <div class="contact-label">Teléfono</div>
              <div class="contact-value">{{ user.telefono }}</div>
            </div>
          </div>
          
          <div class="contact-item" *ngIf="user.direccion">
            <ion-icon name="location" color="primary"></ion-icon>
            <div class="contact-info">
              <div class="contact-label">Ubicación</div>
              <div class="contact-value">{{ user.direccion }}</div>
            </div>
          </div>

          <!-- Response Time Info -->
          <div class="response-info">
            <ion-icon name="time" color="success"></ion-icon>
            <span>Responde generalmente en {{ getResponseTime() }}</span>
          </div>
        </div>

        <!-- Privacy Toggle -->
        <ion-button 
          *ngIf="!isOwnProfile"
          fill="clear" 
          size="small" 
          (click)="toggleContactDetails()"
          class="show-details-btn">
          <ion-icon [name]="showContactDetails ? 'eye-off' : 'eye'" slot="start"></ion-icon>
          {{ showContactDetails ? 'Ocultar' : 'Ver' }} detalles
        </ion-button>
      </div>
    </div>

    <!-- Enhanced Pets Section -->
    <div class="pets-section">
      <div class="section-header">
        <h2 class="section-title">
          <ion-icon name="paw" color="primary"></ion-icon>
          {{ isOwnProfile ? 'Mis Publicaciones' : 'Publicaciones de Adopción' }}
        </h2>
        <div class="pets-filter" *ngIf="pets$ | async as pets">
          <div *ngIf="pets.length > 0">
            <ion-segment [(ngModel)]="selectedPetFilter" (ionChange)="filterPets($event)">
              <ion-segment-button value="all">
                <ion-label>Todas ({{ pets.length }})</ion-label>
              </ion-segment-button>
              <ion-segment-button value="available">
                <ion-label>Disponibles</ion-label>
              </ion-segment-button>
              <ion-segment-button value="adopted" *ngIf="isOwnProfile">
                <ion-label>Adoptadas</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>
        </div>
      </div>

      <div *ngIf="pets$ | async as pets">
        <!-- Empty State -->
        <div *ngIf="pets.length === 0" class="empty-state">
          <div class="empty-content">
            <ion-icon name="paw" class="empty-icon"></ion-icon>
            <h3>{{ isOwnProfile ? 'Publica tu primera mascota!' : 'Sin publicaciones' }}</h3>
            <p>{{ isOwnProfile ? 'Ayuda a una mascota a encontrar su hogar para siempre' : 'Este usuario no tiene mascotas en adopción actualmente' }}</p>
            <ion-button 
              *ngIf="isOwnProfile" 
              routerLink="/crearadopcion" 
              class="publish-btn">
              <ion-icon name="add" slot="start"></ion-icon>
              Publicar Mascota
            </ion-button>
          </div>
        </div>

        <!-- Enhanced Pet Grid -->
        <div *ngIf="pets.length > 0" class="pets-grid">
          <div class="pet-card-wrapper" *ngFor="let pet of getFilteredPets(pets); trackBy: trackPetById">
            <app-card
              [nombre]="pet.nombre"
              [tipoMascota]="pet.tipoMascota"
              [etapaVida]="pet.etapaVida"
              [edadMeses]="pet.edadMeses"
              [edadAnios]="pet.edadAnios"
              [sexo]="pet.sexo"
              [tamano]="pet.tamano"
              [esterilizado]="pet.esterilizado"
              [location]="pet.location"
              [descripcion]="pet.descripcion"
              [urlImagen]="pet.urlImagen"
              (detailsClicked)="goToPetDetails(pet.id)"
              [adopcionId]="pet.id"
              class="enhanced-pet-card">
            </app-card>
          </div>
        </div>

        <!-- Load More Button -->
        <div class="load-more" *ngIf="hasMorePets">
          <ion-button fill="outline" (click)="loadMorePets()" [disabled]="loadingMore">
            <ion-spinner *ngIf="loadingMore" name="crescent" slot="start"></ion-spinner>
            <span>{{ loadingMore ? 'Cargando...' : 'Ver más' }}</span>
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced FAB Actions -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="isOwnProfile" class="profile-fab">
    <ion-fab-button routerLink="/editar-perfil" class="edit-btn" title="Editar Perfil" color="primary">
      <ion-icon name="create"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Contact FAB for other users -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!isOwnProfile" class="contact-fab">
    <ion-fab-button color="success" (click)="openWhatsApp()">
      <ion-icon name="chatbubbles"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>