<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/misadopciones"></ion-back-button>
    </ion-buttons>
    <ion-title>Mis Solicitudes Recibidas</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refreshRequests()" fill="clear">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando solicitudes...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading">
    <!-- Estadísticas -->
    <div class="stats-grid">
      <div class="stat-card total">
        <ion-icon name="mail-outline"></ion-icon>
        <div class="stat-info">
          <div class="stat-number">{{ stats.total }}</div>
          <div class="stat-label">Total Recibidas</div>
        </div>
      </div>
      <div class="stat-card pending">
        <ion-icon name="time-outline"></ion-icon>
        <div class="stat-info">
          <div class="stat-number">{{ stats.pending }}</div>
          <div class="stat-label">Pendientes</div>
        </div>
      </div>
      <div class="stat-card approved">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <div class="stat-info">
          <div class="stat-number">{{ stats.approved }}</div>
          <div class="stat-label">Aprobadas</div>
        </div>
      </div>
      <div class="stat-card completed">
        <ion-icon name="trophy-outline"></ion-icon>
        <div class="stat-info">
          <div class="stat-number">{{ stats.completed }}</div>
          <div class="stat-label">Completadas</div>
        </div>
      </div>
      <div class="stat-card rejected">
        <ion-icon name="close-circle-outline"></ion-icon>
        <div class="stat-info">
          <div class="stat-number">{{ stats.rejected }}</div>
          <div class="stat-label">Rechazadas</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
      <ion-searchbar [(ngModel)]="searchTerm" (ionChange)="onFilterChange()"
        placeholder="Buscar por mascota o solicitante..." animated>
      </ion-searchbar>

      <ion-segment [(ngModel)]="selectedStatus" (ionChange)="onFilterChange()" color="tertiary" scrollable>
        <ion-segment-button value="all">
          <ion-label>Todas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="pending">
          <ion-label>Pendientes</ion-label>
          <ion-badge *ngIf="stats.pending > 0" color="warning">{{ stats.pending }}</ion-badge>
        </ion-segment-button>
        <ion-segment-button value="approved">
          <ion-label>Aprobadas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="rejected">
          <ion-label>Rechazadas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="completed">
          <ion-label>Completadas</ion-label>
          <ion-badge *ngIf="stats.completed > 0" color="success">{{ stats.completed }}</ion-badge>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Requests List -->
    <div class="requests-container">
      <!-- Empty State -->
      <div *ngIf="!hasRequests && !isLoading" class="empty-state">
        <div class="empty-icon-container">
          <ion-icon name="mail-open-outline" class="empty-icon"></ion-icon>
          <div class="paw-decoration">
            <ion-icon name="paw"></ion-icon>
          </div>
        </div>
        <h3>No has recibido solicitudes</h3>
        <p>Aún no has recibido solicitudes de adopción para tus mascotas publicadas.</p>
        <ion-button expand="block" routerLink="/my-adoptions" class="explore-button" size="large">
          <ion-icon name="albums-outline" slot="start"></ion-icon>
          Ver Mis Publicaciones
        </ion-button>
      </div>

      <!-- No Results State -->
      <div *ngIf="hasRequests && filteredRequests.length === 0" class="empty-state">
        <ion-icon name="search-outline"></ion-icon>
        <h3>No hay resultados</h3>
        <p>No se encontraron solicitudes con los filtros aplicados.</p>
      </div>

      <!-- Requests Cards -->
      <div *ngIf="filteredRequests.length > 0" class="requests-list">
        <div *ngFor="let request of filteredRequests" class="request-card-modern"
          [class.pending]="request.status === 'pending'" [class.approved]="request.status === 'approved'"
          [class.rejected]="request.status === 'rejected'">

          <!-- Card Header with Avatar and Info -->
          <div class="card-header">
            <div class="avatar-section">
              <div class="avatar-container">
                <img [src]="request.pet.imageUrl || 'assets/imgs/paw.png'" [alt]="request.pet.name" class="avatar-image"
                  (error)="$any($event.target).src='assets/imgs/paw.png'" />
              </div>
              <div class="requester-info">
                <h3 class="requester-name">{{ request.requester.name }}</h3>
                <p class="solicitud-info">
                  Solicitud: {{ request.requestDate | date:'MMM dd, yyyy, h:mm a' }}
                </p>
              </div>
            </div>

            <div class="status-badge">
              <ion-chip [color]="getStatusColor(request.status)" class="status-chip-modern">
                <ion-label>{{ getStatusText(request.status) }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Pet Name Prominently Displayed -->
          <div class="pet-name-section">
            <h2 class="pet-name">{{ request.pet.name }}</h2>
            <p class="pet-type">{{ request.pet.type }} {{ request.pet.breed ? '• ' + request.pet.breed : '' }}</p>
          </div>

          <!-- Housing Info Tags -->
          <div class="housing-tags">
            <div class="tag" *ngIf="request.housingType">
              <ion-icon name="home-outline"></ion-icon>
              <span>{{ request.housingType === 'own' ? 'Casa Propia' : 'Casa Alquilada' }}</span>
            </div>
            <div class="tag" *ngIf="request.previousExperience !== undefined">
              <ion-icon name="school-outline"></ion-icon>
              <span>{{ request.previousExperience ? 'Con Experiencia' : 'Sin Experiencia' }}</span>
            </div>
            <div class="tag" *ngIf="request.otherPets !== undefined">
              <ion-icon name="paw-outline"></ion-icon>
              <span>{{ request.otherPets ? 'Tiene Otras Mascotas' : 'Sin Otras Mascotas' }}</span>
            </div>
          </div>

          <!-- Attention Points -->
          <div class="attention-points" *ngIf="!request.previousExperience">
            <div class="attention-header">
              <ion-icon name="warning-outline"></ion-icon>
              <span>Puntos de Atención:</span>
            </div>
            <ul class="attention-list">
              <li *ngIf="!request.previousExperience">Sin experiencia previa con mascotas</li>
              <li *ngIf="request.hoursAlone && request.hoursAlone > 8">Mascota sola más de 8 horas al día</li>
            </ul>
          </div>

          <!-- Action Buttons Row -->
          <div class="action-buttons-row">
            <ion-button fill="clear" size="default" color="primary" (click)="viewRequestDetails(request)"
              class="action-btn">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              VER CUESTIONARIO
            </ion-button>

            <ion-button fill="clear" size="default" color="success" (click)="contactViaWhatsApp(request)"
              class="action-btn">
              <ion-icon name="logo-whatsapp" slot="start"></ion-icon>
              CONTACTAR
            </ion-button>
          </div>

          <!-- Contact Icons Row -->
          <div class="contact-icons-row" *ngIf="request.status !== 'rejected'">
            <ion-button fill="clear" size="small" (click)="navigateToRequesterProfile(request)"
              class="contact-icon-btn">
              <ion-icon name="person-circle-outline"></ion-icon>
            </ion-button>

            <ion-button fill="clear" size="small" (click)="callRequester(request)" class="contact-icon-btn">
              <ion-icon name="call-outline"></ion-icon>
            </ion-button>

            <ion-button fill="clear" size="small" (click)="contactViaWhatsApp(request)" class="contact-icon-btn">
              <ion-icon name="logo-whatsapp"></ion-icon>
            </ion-button>

            <ion-button fill="clear" size="small" (click)="emailRequester(request)" class="contact-icon-btn">
              <ion-icon name="mail-outline"></ion-icon>
            </ion-button>
          </div>

          <!-- Decision Buttons -->
          <div class="decision-buttons" *ngIf="request.status === 'pending'">
            <ion-button expand="block" fill="solid" color="success" size="default"
              (click)="respondToRequest(request, 'approve')" class="decision-btn approve-btn">
              APROBAR SOLICITUD
            </ion-button>

            <ion-button expand="block" fill="solid" color="danger" size="default"
              (click)="respondToRequest(request, 'reject')" class="decision-btn reject-btn">
              RECHAZAR SOLICITUD
            </ion-button>
          </div>

          <!-- Delivery Confirmation Section (For Approved Requests) -->
          <div class="delivery-confirmation-section" *ngIf="request.status === 'approved'">
            <div class="delivery-status-info">
              <h4>Estado de Confirmación de Entrega</h4>
              <div class="confirmation-grid">
                <div class="confirmation-item" [class.confirmed]="request.ownerDeliveryConfirmedAt">
                  <ion-icon
                    [name]="request.ownerDeliveryConfirmedAt ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                  <span>Publicador {{ request.ownerDeliveryConfirmedAt ? 'confirmó' : 'pendiente' }}</span>
                  <small *ngIf="request.ownerDeliveryConfirmedAt">{{ request.ownerDeliveryConfirmedAt | date:'short'
                    }}</small>
                </div>
                <div class="confirmation-item" [class.confirmed]="request.adopterDeliveryConfirmedAt">
                  <ion-icon
                    [name]="request.adopterDeliveryConfirmedAt ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                  <span>Adoptante {{ request.adopterDeliveryConfirmedAt ? 'confirmó' : 'pendiente' }}</span>
                  <small *ngIf="request.adopterDeliveryConfirmedAt">{{ request.adopterDeliveryConfirmedAt | date:'short'
                    }}</small>
                </div>
              </div>
            </div>

            <ion-button expand="block" fill="solid" color="tertiary" size="default"
              (click)="confirmDeliveryAsOwner(request)" class="confirm-delivery-btn"
              *ngIf="!request.ownerDeliveryConfirmedAt">
              <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
              CONFIRMAR ENTREGA (PUBLICADOR)
            </ion-button>

            <div class="delivery-confirmed-message" *ngIf="request.ownerDeliveryConfirmedAt">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <p>Has confirmado la entrega. Esperando confirmación del adoptante.</p>
            </div>
          </div>

          <!-- Receipt PDF for completed adoptions -->
          <div class="receipt-section" *ngIf="request.status === 'completed' && request.receiptPdfUrl">
            <h4>Recibo de Entrega Generado</h4>
            <ion-button expand="block" fill="outline" color="primary" size="default"
              (click)="viewReceipt(request.receiptPdfUrl)">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              VER RECIBO DE ADOPCIÓN
            </ion-button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshRequests($event)">
    <ion-refresher-content pullingIcon="chevron-down-circle-outline" pullingText="Desliza para actualizar"
      refreshingSpinner="circles" refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>
</ion-content>