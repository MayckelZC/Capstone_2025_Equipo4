<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Vacunas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-item>
    <ion-label>Seleccionar mascota</ion-label>
    <ion-select [(ngModel)]="selectedPetId" (ionChange)="onPetChange()" placeholder="Elige una mascota">
      <ion-select-option *ngFor="let pet of (pets$ | async)" [value]="pet.id">{{ pet.nombre || (pet.tipoMascota + ' - ' + (pet.etapaVida || '')) }}</ion-select-option>
    </ion-select>
  </ion-item>

  <div *ngIf="!pet" class="empty">
    <p>Selecciona una mascota para ver las vacunas recomendadas según especie.</p>
  </div>

  <div *ngIf="pet">
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ pet.nombre || 'Mascota seleccionada' }}</ion-card-title>
        <ion-card-subtitle>{{ pet.tipoMascota }} • {{ pet.location || '' }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-list-header>
            <ion-label>Vacunas recomendadas ({{ species | titlecase }})</ion-label>
          </ion-list-header>

          <ng-container *ngFor="let vac of vaccines">
            <ion-item>
              <ion-label>
                <h3>{{ vac.nombre }}</h3>
                <p class="muted">{{ vac.esquema.inicio }} — {{ vac.esquema.refuerzos }}</p>
                <p class="small">{{ vac.comentarioChile }}</p>
              </ion-label>

              <ion-toggle slot="end" [checked]="isApplied(vac.id).applied" (ionChange)="toggleApplied(vac, $event.detail.checked)"></ion-toggle>
            </ion-item>

            <ion-item *ngIf="isApplied(vac.id).applied">
              <ion-label>Fecha aplicada</ion-label>
              <ion-datetime 
                [value]="getAppliedDate(vac.id) || ''" 
                (ionChange)="setAppliedDate(vac.id, $event.detail.value)" 
                display-format="DD/MM/YYYY" 
                picker-format="DD MM YYYY"
                cancelText="Cancelar"
                doneText="Confirmar">
              </ion-datetime>
            </ion-item>
          </ng-container>

        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
