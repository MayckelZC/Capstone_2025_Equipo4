<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ pet?.nombre || 'Detalles de Mascota' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleFavorite()" *ngIf="!isOwner">
        <ion-icon slot="icon-only" [name]="isFavorite ? 'heart' : 'heart-outline'"></ion-icon>
      </ion-button>
      <ion-button (click)="shareDetails()">
        <ion-icon slot="icon-only" name="share-social-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Hero image with overlay -->
  <div class="hero-card" *ngIf="pet" aria-live="polite">
    <img 
      class="hero-image" 
      [src]="(pet.gallery && pet.gallery.length) ? pet.gallery[0] : pet.urlImagen || 'assets/imgs/default-dog.png'" 
      [alt]="pet?.nombre || 'Imagen de la mascota'"
      (click)="openImageViewer(0)" 
      [style.opacity]="imageLoaded ? '1' : '0'"
      (load)="imageLoaded = true"
    />
    <ion-skeleton-text 
      *ngIf="!imageLoaded" 
      animated 
      style="width: 100%; height: 320px; margin: 0;"
    ></ion-skeleton-text>
    <div class="hero-overlay" role="presentation">
      <div class="hero-text">
        <div class="hero-badges">
          <ion-chip class="status-chip" *ngIf="pet?.status" [color]="pet?.status === 'available' ? 'success' : 'warning'" size="small">
            <ion-icon name="information-circle-outline"></ion-icon>
            <ion-label>{{ pet?.status | titlecase }}</ion-label>
          </ion-chip>
          <ion-chip class="status-chip" *ngIf="pet?.aptoParaAdopcion !== undefined && pet?.creadorRole === 'organization'" size="small" [color]="pet?.aptoParaAdopcion ? 'success' : 'danger'">
            <ion-icon [name]="pet?.aptoParaAdopcion ? 'shield-checkmark-outline' : 'close-circle-outline'"></ion-icon>
            <ion-label>{{ pet?.aptoParaAdopcion ? 'Apto para adopción' : 'No apto' }}</ion-label>
          </ion-chip>
        </div>
        <h2 class="pet-name">{{ pet?.nombre }}</h2>
        <p class="pet-type">{{ pet?.tipoMascota | titlecase }} · {{ (pet?.tamano | titlecase) || 'Tamaño no registrado' }}</p>
        <p class="hero-location" *ngIf="pet?.ciudad || pet?.barrio">
          <ion-icon name="location-outline"></ion-icon>
          {{ pet?.barrio ? pet?.barrio + ', ' : '' }}{{ pet?.ciudad || 'Ubicación no disponible' }}
        </p>
      </div>
    </div>
  </div>

  <!-- Info list styled like the screenshot -->
  <ion-card class="details-card" *ngIf="pet" aria-labelledby="detalle-informacion">
    <ion-card-header>
      <ion-card-title id="detalle-informacion">Detalles</ion-card-title>
      <ion-card-subtitle>Información básica, características y estado de salud</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="detail-section" aria-label="Información básica">
        <p class="section-label">Información básica</p>
        <ion-list lines="none">
          <ion-item>
            <ion-icon slot="start" name="paw-outline" color="primary"></ion-icon>
            <ion-label>
              <h3>Tipo de Mascota</h3>
              <p>{{ (pet?.tipoMascota | titlecase) || 'N/A' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="resize-outline" color="tertiary"></ion-icon>
            <ion-label>
              <h3>Tamaño</h3>
              <p>{{ (pet?.tamano | titlecase) || 'N/A' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="hourglass-outline" color="warning"></ion-icon>
            <ion-label>
              <h3>Etapa de Vida</h3>
              <p>{{ (pet?.etapaVida | titlecase) || 'N/A' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="calendar-outline" color="secondary"></ion-icon>
            <ion-label>
              <h3>Edad</h3>
              <p>{{ getAgeDisplay(pet) }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <div class="detail-section" aria-label="Características físicas">
        <p class="section-label">Características físicas</p>
        <ion-list lines="none">
          <ion-item *ngIf="pet?.nombre">
            <ion-icon slot="start" name="text-outline"></ion-icon>
            <ion-label>
              <h3>Nombre</h3>
              <p>{{ pet?.nombre }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="male-female-outline" color="primary"></ion-icon>
            <ion-label>
              <h3>Sexo</h3>
              <p>{{ (pet?.sexo | titlecase) || 'N/A' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="color-palette-outline" color="tertiary"></ion-icon>
            <ion-label>
              <h3>Color</h3>
              <p>{{ pet?.color || 'N/A' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item *ngIf="pet?.descripcion">
            <ion-icon slot="start" name="document-text-outline" color="secondary"></ion-icon>
            <ion-label>
              <h3>Descripción</h3>
              <p>{{ pet?.descripcion }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <div class="detail-section" aria-label="Estado de salud">
        <p class="section-label">Estado de salud</p>
        <ion-list lines="none">
          <ion-item>
            <ion-icon slot="start" name="heart-circle-outline" color="success"></ion-icon>
            <ion-label>
              <h3>Esterilizado</h3>
              <p>{{ pet?.esterilizado ? 'Sí' : 'No' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="bandage-outline" color="primary"></ion-icon>
            <ion-label>
              <h3>Vacunas</h3>
              <p>{{ pet?.vacuna ? 'Al día' : 'No' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item>
            <ion-icon slot="start" name="medkit-outline" color="success"></ion-icon>
            <ion-label>
              <h3>Desparasitado</h3>
              <p>{{ pet?.desparasitado ? 'Sí' : 'No' }}</p>
            </ion-label>
          </ion-item>
  
          <ion-item *ngIf="pet?.condicionesSalud">
            <ion-icon slot="start" name="medical-outline"></ion-icon>
            <ion-label>
              <h3>Condiciones de Salud</h3>
              <p>{{ pet?.condicionesSalud }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Personalidad y Compatibilidad -->
  <ion-card class="personality-card" *ngIf="hasPersonalityTraits(pet)">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="happy-outline"></ion-icon>
        Personalidad y Compatibilidad
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="personality-grid">
        <div class="personality-item" *ngIf="pet?.buenoConNinos">
          <ion-icon name="people" color="success"></ion-icon>
          <span>Bueno con niños</span>
        </div>
        <div class="personality-item" *ngIf="pet?.buenoConMascotas">
          <ion-icon name="paw" color="success"></ion-icon>
          <span>Bueno con mascotas</span>
        </div>
        <div class="personality-item" *ngIf="pet?.energetico">
          <ion-icon name="flash" color="warning"></ion-icon>
          <span>Energético</span>
        </div>
        <div class="personality-item" *ngIf="pet?.tranquilo">
          <ion-icon name="leaf" color="success"></ion-icon>
          <span>Tranquilo</span>
        </div>
        <div class="personality-item" *ngIf="pet?.entrenadoEnCasa">
          <ion-icon name="home" color="primary"></ion-icon>
          <span>Entrenado en casa</span>
        </div>
        <div class="personality-item" *ngIf="pet?.guardian">
          <ion-icon name="shield" color="tertiary"></ion-icon>
          <span>Guardián</span>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Ubicación -->
  <ion-card class="location-card" *ngIf="pet?.ciudad || pet?.barrio">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="location-outline"></ion-icon>
        Ubicación
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list lines="none">
        <ion-item *ngIf="pet?.ciudad">
          <ion-icon slot="start" name="business-outline"></ion-icon>
          <ion-label>
            <h3>Ciudad</h3>
            <p>{{ pet?.ciudad }}</p>
          </ion-label>
        </ion-item>
        <ion-item *ngIf="pet?.barrio">
          <ion-icon slot="start" name="home-outline"></ion-icon>
          <ion-label>
            <h3>Barrio/Comuna</h3>
            <p>{{ pet?.barrio }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Publicador con cabecera verde similar a la captura -->
  <section *ngIf="user && !publisherNotFound" class="publisher-section" aria-labelledby="publisher-info">
    <ion-card class="publisher-card">
      <ion-card-header>
        <ion-card-title id="publisher-info">Información del Publicador</ion-card-title>
        <ion-card-subtitle>Canales de contacto y perfil verificado</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-icon slot="start" name="person-outline"></ion-icon>
            <ion-label>
              <h3>Nombre Completo</h3>
              <p class="link" (click)="viewPublisherProfile()">{{ user.nombreCompleto }}</p>
            </ion-label>
            <ion-badge color="success" *ngIf="user.role === 'organization'">Organización</ion-badge>
          </ion-item>

          <ion-item *ngIf="user.email">
            <ion-icon slot="start" name="mail-outline"></ion-icon>
            <ion-label>
              <h3>Email</h3>
              <p class="link" (click)="emailPublisher()">{{ user.email }}</p>
            </ion-label>
            <ion-button fill="clear" size="small" (click)="emailPublisher()" aria-label="Enviar correo">
              <ion-icon name="send-outline"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-item *ngIf="user.telefono">
            <ion-icon slot="start" name="logo-whatsapp"></ion-icon>
            <ion-label>
              <h3>Teléfono</h3>
              <a [href]="getWhatsAppLink(user.telefono)" target="_blank" rel="noopener noreferrer" class="whatsapp-link">
                <p class="link">{{ user.telefono }}</p>
              </a>
            </ion-label>
            <ion-button fill="outline" size="small" (click)="callPublisher()" aria-label="Llamar al publicador">
              <ion-icon slot="start" name="call-outline"></ion-icon>
              Llamar
            </ion-button>
          </ion-item>

          <ion-item *ngIf="user.direccion">
            <ion-icon slot="start" name="location-outline"></ion-icon>
            <ion-label>
              <h3>Dirección</h3>
              <p>{{ user.direccion }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </section>

  <!-- Action buttons -->
  <ion-card class="actions-card" *ngIf="pet">
    <ion-card-header>
      <ion-card-title>Acciones y seguimiento</ion-card-title>
      <ion-card-subtitle>
        Mantén el proceso organizado desde este panel
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <!-- Botón ADOPTAR -->
      <ng-container *ngIf="!isOwner && pet?.status === 'available'">
        <ion-button expand="block" class="primary-cta" (click)="solicitarAdopcion()" [disabled]="(hasPendingRequest$ | async)">
          <ion-icon slot="start" name="paw"></ion-icon>
          {{ (hasPendingRequest$ | async) ? 'SOLICITUD ENVIADA' : 'ADOPTAR' }}
        </ion-button>
        <ion-note color="medium" *ngIf="(hasPendingRequest$ | async)">Ya enviaste una solicitud. Espera respuesta del publicador.</ion-note>
      </ng-container>

      <!-- Proceso de Confirmación de Entrega (2 vías) -->
      <ng-container *ngIf="pet?.status === 'handover_pending'">
        <ion-card class="handover-card">
          <ion-card-header>
            <ion-card-title>Confirmación de Entrega</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Vista para el Dador (Owner) -->
            <div *ngIf="isOwner">
              <p *ngIf="!pet.giverConfirmedHandover">Por favor, confirma cuando hayas entregado la mascota.</p>
              <ion-button expand="block" color="success" (click)="confirmHandover()" [disabled]="pet.giverConfirmedHandover">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Confirmar Entrega
              </ion-button>
              <p *ngIf="pet.giverConfirmedHandover" class="confirmation-status">
                <ion-icon name="checkmark-done-outline"></ion-icon>
                Tú has confirmado la entrega. Esperando confirmación del adoptante.
              </p>
            </div>

            <!-- Vista para el Adoptante -->
            <div *ngIf="isAdopter">
              <p *ngIf="!pet.adopterConfirmedReceipt">Por favor, confirma cuando hayas recibido la mascota.</p>
              <ion-button expand="block" color="success" (click)="confirmReceipt()" [disabled]="pet.adopterConfirmedReceipt">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Confirmar Recepción
              </ion-button>
              <p *ngIf="pet.adopterConfirmedReceipt" class="confirmation-status">
                <ion-icon name="checkmark-done-outline"></ion-icon>
                Tú has confirmado la recepción. Esperando confirmación del dador.
              </p>
            </div>

            <!-- Estado general visible para ambos -->
            <div class="handover-status">
              <ion-item lines="none">
                <ion-icon [name]="pet.giverConfirmedHandover ? 'checkmark-circle' : 'ellipse-outline'" [color]="pet.giverConfirmedHandover ? 'success' : 'medium'" slot="start"></ion-icon>
                <ion-label>Entrega confirmada por el dador</ion-label>
              </ion-item>
              <ion-item lines="none">
                <ion-icon [name]="pet.adopterConfirmedReceipt ? 'checkmark-circle' : 'ellipse-outline'" [color]="pet.adopterConfirmedReceipt ? 'success' : 'medium'" slot="start"></ion-icon>
                <ion-label>Recepción confirmada por el adoptante</ion-label>
              </ion-item>
            </div>
          </ion-card-content>
        </ion-card>
      </ng-container>

      <!-- Mensaje para el dador -->
      <ion-note *ngIf="isOwner && pet?.status !== 'handover_pending'" color="medium" class="owner-note">
        Esta es tu publicación. Para gestionar solicitudes, visita "Mis Solicitudes Recibidas".
      </ion-note>

      <!-- Botón de favoritos solo si NO es el dueño -->
      <ng-container *ngIf="!isOwner">
        <ion-button expand="block" class="secondary-cta" (click)="toggleFavorite()" [disabled]="favoriteInFlight">
          <ion-icon slot="start" [name]="isFavorite ? 'heart' : 'heart-outline'"></ion-icon>
          {{ isFavorite ? 'ELIMINAR DE FAVORITOS' : 'AÑADIR A FAVORITOS' }}
        </ion-button>
      </ng-container>

      <!-- Ocultar la opción de reportar si el usuario es el publicador de la mascota -->
      <ng-container *ngIf="!isOwner">
        <ion-button expand="block" class="secondary-cta danger" (click)="openReportModal()" color="danger">
          <ion-icon slot="start" name="flag-outline"></ion-icon>
          REPORTAR
        </ion-button>
      </ng-container>
    </ion-card-content>
  </ion-card>
</ion-content>
