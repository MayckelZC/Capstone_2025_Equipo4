<ion-header class="ion-no-border">
  <ion-toolbar class="header-toolbar">
    <ion-title class="header-title">
      <span>Cuestionario de Adopci√≥n</span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" class="close-button">
        <ion-icon name="close-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Auto-save Indicator -->
  <div class="auto-save-indicator" *ngIf="showSavedIndicator">
    <ion-icon name="cloud-done-outline"></ion-icon>
    <span>Guardado {{lastSavedTime}}</span>
  </div>
  
  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-steps">
      <div class="step" [class.active]="currentStep >= 1" [class.current]="currentStep === 1">
        <div class="step-circle">
          <ion-icon [name]="currentStep > 1 ? 'checkmark' : 'home-outline'"></ion-icon>
        </div>
        <span class="step-label">Vivienda</span>
      </div>
      <div class="step-line" [class.active]="currentStep > 1"></div>
      <div class="step" [class.active]="currentStep >= 2" [class.current]="currentStep === 2">
        <div class="step-circle">
          <ion-icon [name]="currentStep > 2 ? 'checkmark' : 'calendar-outline'"></ion-icon>
        </div>
        <span class="step-label">Estilo</span>
      </div>
      <div class="step-line" [class.active]="currentStep > 2"></div>
      <div class="step" [class.active]="currentStep >= 3" [class.current]="currentStep === 3">
        <div class="step-circle">
          <ion-icon [name]="currentStep > 3 ? 'checkmark' : 'paw-outline'"></ion-icon>
        </div>
        <span class="step-label">Experiencia</span>
      </div>
      <div class="step-line" [class.active]="currentStep > 3"></div>
      <div class="step" [class.active]="currentStep >= 4" [class.current]="currentStep === 4">
        <div class="step-circle">
          <ion-icon name="heart-outline"></ion-icon>
        </div>
        <span class="step-label">Compromiso</span>
      </div>
    </div>
  </div>
</ion-header>

<ion-content>
  <div class="content-wrapper">
    <form [formGroup]="questionnaireForm" class="questionnaire-form">
      <!-- Step 1: Vivienda y Seguridad -->
      <div *ngIf="currentStep === 1" class="step-content">
        <div class="step-header">
          <div class="icon-wrapper">
            <ion-icon name="home" class="step-icon"></ion-icon>
          </div>
          <h2>Vivienda y Seguridad</h2>
          <p class="step-description">Cu√©ntanos sobre tu hogar</p>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('housingType')" [class.invalid]="isFieldInvalid('housingType')">
          <div class="question-label">
            <ion-icon name="business-outline"></ion-icon>
            <span>¬øVives en casa propia o alquilada?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('housingType')"></ion-icon>
          </div>
          <ion-select formControlName="housingType" interface="popover" class="custom-select">
            <ion-select-option value="own">üè† Casa Propia</ion-select-option>
            <ion-select-option value="rented">üèòÔ∏è Casa Alquilada</ion-select-option>
          </ion-select>
        </div>

        <div class="question-card" *ngIf="questionnaireForm.get('housingType')?.value === 'rented'" [class.valid]="isFieldValid('landlordAllowsPets')" [class.invalid]="isFieldInvalid('landlordAllowsPets')">
          <div class="question-label">
            <ion-icon name="document-text-outline"></ion-icon>
            <span>¬øEl arrendador permite mascotas?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('landlordAllowsPets')"></ion-icon>
          </div>
          <ion-select formControlName="landlordAllowsPets" interface="popover" class="custom-select">
            <ion-select-option [value]="true">‚úÖ S√≠, permite</ion-select-option>
            <ion-select-option [value]="false">‚ùå No permite</ion-select-option>
          </ion-select>
          <div class="error-text" *ngIf="isFieldInvalid('landlordAllowsPets')">
            ‚ö†Ô∏è Este campo es requerido para casas alquiladas
          </div>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('secureFencing')" [class.invalid]="isFieldInvalid('secureFencing')">
          <div class="question-label">
            <ion-icon name="leaf-outline"></ion-icon>
            <span>¬øTu jard√≠n o balc√≥n est√° debidamente cercado/asegurado?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('secureFencing')"></ion-icon>
          </div>
          <ion-select formControlName="secureFencing" interface="popover" class="custom-select">
            <ion-select-option [value]="true">‚úÖ S√≠, est√° asegurado</ion-select-option>
            <ion-select-option [value]="false">‚ùå No est√° asegurado</ion-select-option>
            <ion-select-option [value]="null">‚ûñ No aplica</ion-select-option>
          </ion-select>
        </div>

        <div class="button-group">
          <ion-button expand="block" (click)="nextStep()" [disabled]="!isStepValid(1)" class="next-button">
            <span>Siguiente</span>
            <ion-icon name="arrow-forward" slot="end"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Step 2: Estilo de Vida -->
      <div *ngIf="currentStep === 2" class="step-content">
        <div class="step-header">
          <div class="icon-wrapper">
            <ion-icon name="calendar" class="step-icon"></ion-icon>
          </div>
          <h2>Estilo de Vida</h2>
          <p class="step-description">Informaci√≥n sobre tu rutina diaria</p>
        </div>

        <div class="question-card">
          <div class="question-label">
            <ion-icon name="location-outline"></ion-icon>
            <span>¬øD√≥nde vivir√° la mascota?</span>
          </div>
          <ion-select formControlName="petLivingSpace" interface="popover" class="custom-select">
            <ion-select-option value="indoor">üè† Interior</ion-select-option>
            <ion-select-option value="indoor_with_garden">üå≥ Interior con jard√≠n</ion-select-option>
            <ion-select-option value="outdoor">üå§Ô∏è Exterior</ion-select-option>
            <ion-select-option value="other">üìç Otro</ion-select-option>
          </ion-select>
        </div>

        <div class="question-card" *ngIf="questionnaireForm.get('petLivingSpace')?.value === 'other'">
          <div class="question-label">
            <ion-icon name="create-outline"></ion-icon>
            <span>Especificar otro espacio</span>
          </div>
          <ion-input formControlName="petLivingSpaceOther" placeholder="Describe el espacio..." class="custom-input"></ion-input>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('hoursAlone')" [class.invalid]="isFieldInvalid('hoursAlone')">
          <div class="question-label">
            <ion-icon name="time-outline"></ion-icon>
            <span>¬øCu√°ntas horas al d√≠a estar√° sola la mascota?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('hoursAlone')"></ion-icon>
          </div>
          <ion-input formControlName="hoursAlone" type="number" placeholder="Ej: 4" class="custom-input"></ion-input>
          <div class="tip-text" *ngIf="getTip('hoursAlone')">{{getTip('hoursAlone')}}</div>
          <div class="warning-text" *ngIf="getWarningForHours()">{{getWarningForHours()}}</div>
          <div class="error-text" *ngIf="isFieldInvalid('hoursAlone')">
            ‚ö†Ô∏è Ingresa un n√∫mero v√°lido entre 0 y 24
          </div>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('householdMembers')" [class.invalid]="isFieldInvalid('householdMembers')">
          <div class="question-label">
            <ion-icon name="people-outline"></ion-icon>
            <span>¬øQui√©nes viven en el hogar?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('householdMembers')"></ion-icon>
          </div>
          <ion-input formControlName="householdMembers" placeholder="Ej: 2 adultos, 1 ni√±o de 8 a√±os" class="custom-input"></ion-input>
          <div class="tip-text" *ngIf="getTip('householdMembers')">{{getTip('householdMembers')}}</div>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('allergies')" [class.invalid]="isFieldInvalid('allergies')">
          <div class="question-label">
            <ion-icon name="medical-outline"></ion-icon>
            <span>¬øAlguien en casa tiene alergias?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('allergies')"></ion-icon>
          </div>
          <ion-select formControlName="allergies" interface="popover" class="custom-select">
            <ion-select-option value="yes">‚ö†Ô∏è S√≠</ion-select-option>
            <ion-select-option value="no">‚úÖ No</ion-select-option>
            <ion-select-option value="unknown">‚ùì No s√©</ion-select-option>
          </ion-select>
          <div class="tip-text" *ngIf="getTip('allergies')">{{getTip('allergies')}}</div>
        </div>

        <div class="button-group">
          <ion-button expand="block" fill="outline" (click)="prevStep()" class="prev-button">
            <ion-icon name="arrow-back" slot="start"></ion-icon>
            <span>Anterior</span>
          </ion-button>
          <ion-button expand="block" (click)="nextStep()" [disabled]="!isStepValid(2)" class="next-button">
            <span>Siguiente</span>
            <ion-icon name="arrow-forward" slot="end"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Step 3: Experiencia y Mascotas -->
      <div *ngIf="currentStep === 3" class="step-content">
        <div class="step-header">
          <div class="icon-wrapper">
            <ion-icon name="paw" class="step-icon"></ion-icon>
          </div>
          <h2>Experiencia y Mascotas</h2>
          <p class="step-description">Tu experiencia con animales</p>
        </div>

        <div class="question-card">
          <div class="question-label">
            <ion-icon name="ribbon-outline"></ion-icon>
            <span>¬øHas tenido mascotas antes?</span>
          </div>
          <ion-select formControlName="previousExperience" interface="popover" class="custom-select">
            <ion-select-option [value]="true">‚úÖ S√≠</ion-select-option>
            <ion-select-option [value]="false">‚ùå No</ion-select-option>
          </ion-select>
        </div>

        <div class="question-card" *ngIf="questionnaireForm.get('previousExperience')?.value === true" [class.valid]="isFieldValid('previousExperienceDetails')" [class.invalid]="isFieldInvalid('previousExperienceDetails')">
          <div class="question-label">
            <ion-icon name="document-text-outline"></ion-icon>
            <span>Detalla tu experiencia</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('previousExperienceDetails')"></ion-icon>
          </div>
          <ion-textarea formControlName="previousExperienceDetails" placeholder="Especie, cu√°nto tiempo, qu√© ocurri√≥..." rows="4" class="custom-textarea" [maxlength]="MAX_CHAR_DETAILS"></ion-textarea>
          <div class="char-counter" [ngClass]="getCharCountColor('previousExperienceDetails', MAX_CHAR_DETAILS)">
            {{getCharCount('previousExperienceDetails')}}/{{MAX_CHAR_DETAILS}} caracteres
          </div>
        </div>

        <div class="question-card">
          <div class="question-label">
            <ion-icon name="paw-outline"></ion-icon>
            <span>¬øTienes otras mascotas ahora?</span>
          </div>
          <ion-select formControlName="otherPets" interface="popover" class="custom-select">
            <ion-select-option [value]="true">‚úÖ S√≠</ion-select-option>
            <ion-select-option [value]="false">‚ùå No</ion-select-option>
          </ion-select>
        </div>

        <div class="question-card" *ngIf="questionnaireForm.get('otherPets')?.value === true" [class.valid]="isFieldValid('otherPetsDetails')" [class.invalid]="isFieldInvalid('otherPetsDetails')">
          <div class="question-label">
            <ion-icon name="list-outline"></ion-icon>
            <span>Indica especie, edad y estado de vacunaci√≥n</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('otherPetsDetails')"></ion-icon>
          </div>
          <ion-textarea formControlName="otherPetsDetails" placeholder="Ej: Perro Golden Retriever, 5 a√±os, vacunas al d√≠a" rows="4" class="custom-textarea" [maxlength]="MAX_CHAR_DETAILS"></ion-textarea>
          <div class="char-counter" [ngClass]="getCharCountColor('otherPetsDetails', MAX_CHAR_DETAILS)">
            {{getCharCount('otherPetsDetails')}}/{{MAX_CHAR_DETAILS}} caracteres
          </div>
        </div>

        <div class="question-card">
          <ion-icon name="restaurant-outline"></ion-icon>
          <div class="question-label">
            <span>¬øQu√© tipo de alimentaci√≥n planeas darle?</span>
          </div>
          <ion-input formControlName="petFood" placeholder="Ej: Alimento balanceado premium" class="custom-input"></ion-input>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('veterinaryAccess')" [class.invalid]="isFieldInvalid('veterinaryAccess')">
          <div class="question-label">
            <ion-icon name="medical-outline"></ion-icon>
            <span>¬øTienes acceso a atenci√≥n veterinaria?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('veterinaryAccess')"></ion-icon>
          </div>
          <ion-select formControlName="veterinaryAccess" interface="popover" class="custom-select">
            <ion-select-option [value]="true">‚úÖ S√≠, tengo acceso confirmado</ion-select-option>
            <ion-select-option [value]="false">‚ùå No tengo acceso confirmado</ion-select-option>
          </ion-select>
          <div class="tip-text">üí° Es importante contar con un veterinario de confianza para emergencias y chequeos regulares.</div>
        </div>

        <div class="question-card">
          <div class="question-label">
            <ion-icon name="fitness-outline"></ion-icon>
            <span>¬øAceptar√≠as cubrir gastos veterinarios inesperados?</span>
          </div>
          <ion-select formControlName="unexpectedExpenses" interface="popover" class="custom-select">
            <ion-select-option [value]="true">‚úÖ S√≠, estoy preparado</ion-select-option>
            <ion-select-option [value]="false">‚ùå No puedo garantizarlo</ion-select-option>
          </ion-select>
        </div>

        <div class="button-group">
          <ion-button expand="block" fill="outline" (click)="prevStep()" class="prev-button">
            <ion-icon name="arrow-back" slot="start"></ion-icon>
            <span>Anterior</span>
          </ion-button>
          <ion-button expand="block" (click)="nextStep()" [disabled]="!isStepValid(3)" class="next-button">
            <span>Siguiente</span>
            <ion-icon name="arrow-forward" slot="end"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Step 4: Compromiso -->
      <div *ngIf="currentStep === 4" class="step-content">
        <div class="step-header">
          <div class="icon-wrapper">
            <ion-icon name="heart-circle" class="step-icon"></ion-icon>
          </div>
          <h2>Compromiso</h2>
          <p class="step-description">Tu compromiso con la mascota</p>
        </div>

        <div class="question-card" [class.valid]="isFieldValid('longTermCommitment')" [class.invalid]="isFieldInvalid('longTermCommitment')">
          <div class="question-label">
            <ion-icon name="help-circle-outline"></ion-icon>
            <span>¬øQu√© har√≠as si no pudieras seguir cuidando a la mascota?</span>
            <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('longTermCommitment')"></ion-icon>
          </div>
          <ion-textarea formControlName="longTermCommitment" placeholder="Describe tu plan en caso de no poder continuar con el cuidado..." rows="4" class="custom-textarea" [maxlength]="MAX_CHAR_COMMITMENT"></ion-textarea>
          <div class="char-counter" [ngClass]="getCharCountColor('longTermCommitment', MAX_CHAR_COMMITMENT)">
            {{getCharCount('longTermCommitment')}}/{{MAX_CHAR_COMMITMENT}} caracteres
          </div>
          <div class="tip-text" *ngIf="getTip('longTermCommitment')">{{getTip('longTermCommitment')}}</div>
        </div>

        <div class="question-card checkbox-card" [class.invalid]="isFieldInvalid('verificationConsent')">
          <ion-checkbox formControlName="verificationConsent" class="custom-checkbox"></ion-checkbox>
          <div class="checkbox-content">
            <div class="checkbox-label">
              <ion-icon name="shield-checkmark-outline"></ion-icon>
              <span>Verificaci√≥n de Informaci√≥n</span>
              <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('verificationConsent')"></ion-icon>
            </div>
            <p>Acepto que la informaci√≥n sea verificada y que se puedan realizar visitas domiciliarias.</p>
          </div>
        </div>

        <!-- Compromiso de Adopci√≥n -->
        <div class="commitment-document">
          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="document-text"></ion-icon>
                Compromiso de Adopci√≥n
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <p class="document-intro">
                Al enviar esta solicitud, acepto y me comprometo a cumplir con los siguientes t√©rminos:
              </p>
              
              <div class="commitment-list">
                <div class="commitment-item">
                  <ion-icon name="time-outline" color="primary"></ion-icon>
                  <span><strong>Cuidado a largo plazo:</strong> Las mascotas viven 10-15 a√±os o m√°s. Me comprometo a cuidarla durante toda su vida.</span>
                </div>
                
                <div class="commitment-item">
                  <ion-icon name="medical-outline" color="primary"></ion-icon>
                  <span><strong>Gastos veterinarios:</strong> Asumo la responsabilidad de todos los gastos m√©dicos y veterinarios.</span>
                </div>
                
                <div class="commitment-item">
                  <ion-icon name="heart-outline" color="primary"></ion-icon>
                  <span><strong>No abandono:</strong> Me comprometo a no abandonar a la mascota bajo ninguna circunstancia.</span>
                </div>
                
                <div class="commitment-item">
                  <ion-icon name="return-up-back-outline" color="primary"></ion-icon>
                  <span><strong>Pol√≠tica de devoluci√≥n:</strong> Si no puedo continuar con el cuidado, contactar√© al due√±o original, NO la abandonar√©.</span>
                </div>
                
                <div class="commitment-item">
                  <ion-icon name="warning-outline" color="warning"></ion-icon>
                  <span><strong>Consecuencias legales:</strong> Acepto las consecuencias legales en caso de maltrato o abandono.</span>
                </div>
                
                <div class="commitment-item">
                  <ion-icon name="home-outline" color="primary"></ion-icon>
                  <span><strong>Cambio de domicilio:</strong> Me comprometo a notificar cualquier cambio de direcci√≥n.</span>
                </div>
              </div>

              <div class="question-card checkbox-card" [class.invalid]="isFieldInvalid('adoptionCommitment')">
                <ion-checkbox formControlName="adoptionCommitment" class="custom-checkbox"></ion-checkbox>
                <div class="checkbox-content">
                  <div class="checkbox-label">
                    <ion-icon name="document-text-outline"></ion-icon>
                    <span><strong>He le√≠do y acepto el Compromiso de Adopci√≥n</strong></span>
                    <ion-icon name="checkmark-circle" class="validation-icon valid-icon" *ngIf="isFieldValid('adoptionCommitment')"></ion-icon>
                  </div>
                  <p class="legal-note">Este documento tiene validez legal y ser√° almacenado permanentemente.</p>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <div class="final-message">
          <ion-icon name="information-circle-outline"></ion-icon>
          <p>¬°Est√°s a punto de completar tu solicitud! Verifica que todos los campos est√©n correctos antes de enviar.</p>
        </div>

        <div class="button-group">
          <ion-button expand="block" fill="outline" (click)="prevStep()" class="prev-button">
            <ion-icon name="arrow-back" slot="start"></ion-icon>
            <span>Anterior</span>
          </ion-button>
          <ion-button 
            expand="block" 
            (click)="submit()" 
            class="submit-button"
            [disabled]="!canSubmit()"
          >
            <ion-icon name="send-outline" slot="start"></ion-icon>
            <span>Enviar Solicitud</span>
          </ion-button>
        </div>

        <div class="saved-progress-info" *ngIf="lastSavedTime">
          <ion-icon name="save-outline"></ion-icon>
          <span>√öltimo guardado: {{lastSavedTime}}</span>
        </div>
      </div>
    </form>
  </div>
</ion-content>
