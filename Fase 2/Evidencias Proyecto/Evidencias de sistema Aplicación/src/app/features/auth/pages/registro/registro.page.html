<ion-header class="modern-header">
  <ion-toolbar color="primary" class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/auth/login" class="back-button"></ion-back-button>
    </ion-buttons>
    <ion-title class="header-title">Únete a la Familia</ion-title>
  </ion-toolbar>
  <div class="progress-container">
    <div class="progress-bar" [style.width.%]="(currentStep / 3) * 100"></div>
  </div>
</ion-header>

<ion-content>
  <!-- Animated Background -->
  <div class="animated-background">
    <div class="background-shapes">
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
      <div class="shape shape-3"></div>
      <div class="shape shape-4"></div>
      <div class="shape shape-5"></div>
    </div>
  </div>

  <div class="container">
    <div class="registration-card">
      <!-- Card Header -->
      <div class="card-header">
        <div class="logo-section">
          <img src="assets/imgs/logo.png" alt="Logo de la App" class="app-logo" loading="lazy">
          <div class="logo-glow"></div>
        </div>
        <h1 class="main-title">Únete a la Manada</h1>
        <p class="main-subtitle">Crea tu cuenta y comienza a cambiar vidas</p>
      </div>

      <!-- Card Content -->
      <div class="card-content">
        <!-- Enhanced Stepper -->
        <div class="modern-stepper">
          <div class="step-line"></div>
          <div class="step-item" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
            <div class="step-circle">
              <ion-icon name="key" class="step-icon"></ion-icon>
              <ion-icon name="checkmark" class="check-icon"></ion-icon>
            </div>
            <span class="step-label">Cuenta</span>
          </div>
          <div class="step-item" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
            <div class="step-circle">
              <ion-icon name="person" class="step-icon"></ion-icon>
              <ion-icon name="checkmark" class="check-icon"></ion-icon>
            </div>
            <span class="step-label">Personal</span>
          </div>
          <div class="step-item" [class.active]="currentStep === 3" [class.completed]="false">
            <div class="step-circle">
              <ion-icon name="camera" class="step-icon"></ion-icon>
              <ion-icon name="checkmark" class="check-icon"></ion-icon>
            </div>
            <span class="step-label">Foto</span>
          </div>
        </div>

        <form [formGroup]="cuentaForm" (ngSubmit)="onSubmit()">

          <div class="form-step" [class.active]="currentStep === 1">
            <ion-item lines="none">
              <ion-icon name="at-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Nombre de Usuario</ion-label>
              <ion-input formControlName="nombreUsuario" (ionInput)="filterUsernameInput($event)"
                [clearInput]="true"></ion-input>
              <ion-spinner *ngIf="cuentaForm.get('nombreUsuario')?.pending" slot="end" name="dots"></ion-spinner>
              <ion-icon *ngIf="cuentaForm.get('nombreUsuario')?.valid && !cuentaForm.get('nombreUsuario')?.pending"
                name="checkmark-circle" color="success" slot="end"></ion-icon>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('nombreUsuario')?.hasError('minlength')" color="danger">
              Mínimo 3 caracteres.
            </ion-note>
            <ion-note *ngIf="cuentaForm.get('nombreUsuario')?.hasError('usernameTaken')" color="danger">
              Este nombre de usuario ya está en uso.
            </ion-note>

            <ion-item lines="none">
              <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Correo Electrónico</ion-label>
              <ion-input formControlName="correo" type="email" [clearInput]="true"></ion-input>
              <ion-spinner *ngIf="cuentaForm.get('correo')?.pending" slot="end" name="dots"></ion-spinner>
              <ion-icon *ngIf="cuentaForm.get('correo')?.valid && !cuentaForm.get('correo')?.pending"
                name="checkmark-circle" color="success" slot="end"></ion-icon>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('correo')?.hasError('email')" color="danger">
              Correo no válido.
            </ion-note>
            <ion-note *ngIf="cuentaForm.get('correo')?.hasError('emailTaken')" color="danger">
              Este correo ya está registrado.
            </ion-note>

            <ion-item lines="none" class="password-item">
              <ion-icon name="lock-closed-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Contraseña</ion-label>
              <ion-input formControlName="contraseña" [type]="passwordType" [clearInput]="true"></ion-input>
              <!-- Keep only the visibility toggle; the clear 'x' is provided automatically by Ionic -->
              <ion-button fill="clear" slot="end" (click)="togglePasswordVisibility('password')"
                aria-label="Mostrar u ocultar contraseña">
                <ion-icon [name]="passwordToggleIcon" class="password-toggle"></ion-icon>
              </ion-button>
            </ion-item>

            <!-- Password Strength Meter -->
            <div class="password-strength-container" *ngIf="cuentaForm.get('contraseña')?.value">
              <div class="strength-bar">
                <div class="strength-fill" [style.width.%]="(passwordStrength / 4) * 100"
                  [class.weak]="passwordStrength <= 1" [class.medium]="passwordStrength === 2 || passwordStrength === 3"
                  [class.strong]="passwordStrength === 4"></div>
              </div>
              <span class="strength-text">
                {{ passwordStrength <= 1 ? 'Débil' : (passwordStrength <=3 ? 'Media' : 'Fuerte' ) }} </span>
            </div>

            <div *ngIf="cuentaForm.get('contraseña')?.errors as errors" class="error-container">
              <ion-note *ngIf="errors?.['minlength']" color="danger">Mínimo 8 caracteres.</ion-note>
              <ion-note *ngIf="errors?.['noUppercase']" color="danger">Una mayúscula.</ion-note>
              <ion-note *ngIf="errors?.['noLowercase']" color="danger">Una minúscula.</ion-note>
              <ion-note *ngIf="errors?.['noNumber']" color="danger">Un número.</ion-note>
              <ion-note *ngIf="errors?.['noSpecialChar']" color="danger">Un carácter especial.</ion-note>
            </div>

            <ion-item lines="none" class="password-item">
              <ion-icon name="lock-closed-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Confirmar Contraseña</ion-label>
              <ion-input formControlName="confirmarContraseña" [type]="confirmPasswordType"
                [clearInput]="true"></ion-input>
              <ion-button fill="clear" slot="end" (click)="togglePasswordVisibility('confirmPassword')"
                aria-label="Mostrar u ocultar confirmar contraseña">
                <ion-icon [name]="confirmPasswordToggleIcon" class="password-toggle"></ion-icon>
              </ion-button>
            </ion-item>
            <ion-note *ngIf="cuentaForm.hasError('passwordMismatch')" color="danger">
              Las contraseñas no coinciden.
            </ion-note>
          </div>

          <div class="form-step" [class.active]="currentStep === 2">
            <ion-item lines="none">
              <ion-icon name="person-circle-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Nombre Completo</ion-label>
              <ion-input formControlName="nombreCompleto" (ionInput)="filterNumericInput($event)"
                [clearInput]="true"></ion-input>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('nombreCompleto')?.hasError('pattern')" color="danger">
              Solo se permiten letras y espacios.
            </ion-note>

            <ion-item lines="none">
              <ion-icon name="call-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Teléfono</ion-label>
              <ion-input formControlName="telefono" type="tel" [clearInput]="true"></ion-input>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('telefono')?.hasError('pattern')" color="danger">
              Teléfono no válido.
            </ion-note>

            <ion-item lines="none">
              <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Dirección</ion-label>
              <ion-input formControlName="direccion" [clearInput]="true"></ion-input>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('direccion')?.hasError('minlength')" color="danger">
              Mínimo 5 caracteres.
            </ion-note>

            <ion-item lines="none">
              <ion-icon name="map-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Región</ion-label>
              <ion-input formControlName="region" [clearInput]="true"></ion-input>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('region')?.hasError('minlength')" color="danger">
              Mínimo 3 caracteres.
            </ion-note>

            <ion-item lines="none">
              <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Ciudad</ion-label>
              <ion-input formControlName="ciudad" [clearInput]="true"></ion-input>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('ciudad')?.hasError('minlength')" color="danger">
              Mínimo 3 caracteres.
            </ion-note>
          </div>

          <div class="form-step" [class.active]="currentStep === 3">
            <div class="ion-text-center profile-avatar-container">
              <ion-avatar class="profile-avatar" (click)="takePicture()">
                <img [src]="previewImage || 'assets/imgs/paw.png'" alt="Foto de perfil" loading="lazy">
                <div class="camera-overlay">
                  <ion-icon name="camera-outline"></ion-icon>
                </div>
              </ion-avatar>
              <ion-button fill="clear" (click)="takePicture()" class="select-photo-button">
                Seleccionar Foto
              </ion-button>
            </div>

            <!-- Terms and Conditions -->
            <ion-item lines="none" class="terms-item">
              <ion-checkbox slot="start" formControlName="terminos"></ion-checkbox>
              <ion-label class="ion-text-wrap terms-label">
                Acepto los <a routerLink="/terminos">Términos y Condiciones</a> y la <a
                  routerLink="/privacidad">Política de Privacidad</a>.
              </ion-label>
            </ion-item>
            <ion-note *ngIf="cuentaForm.get('terminos')?.touched && cuentaForm.get('terminos')?.invalid" color="danger"
              class="ion-padding-start">
              Debes aceptar los términos para continuar.
            </ion-note>
          </div>

          <div class="button-group">
            <ion-button *ngIf="currentStep > 1" (click)="previousStep()" class="primary-button">
              Anterior
            </ion-button>
            <ion-button *ngIf="currentStep < 3" (click)="nextStep()" class="primary-button"
              [class.ion-margin-start]="currentStep > 1">
              Siguiente
            </ion-button>
            <ion-button *ngIf="currentStep === 3" expand="full" type="submit" [disabled]="!cuentaForm.valid || loading"
              class="primary-button">
              <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
              <span *ngIf="!loading">Crear Cuenta</span>
            </ion-button>
          </div>
        </form>

        <!-- Footer Actions -->
        <div class="footer-actions">
          <div class="already-member">
            <span class="already-text">¿Ya tienes cuenta?</span>
            <a (click)="goToLogin()" class="login-link">
              <ion-icon name="log-in-outline"></ion-icon>
              Iniciar Sesión
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Decorative Elements -->
    <div class="floating-decorations">
      <ion-icon name="paw" class="float-icon float-1"></ion-icon>
      <ion-icon name="heart" class="float-icon float-2"></ion-icon>
      <ion-icon name="paw" class="float-icon float-3"></ion-icon>
      <ion-icon name="star" class="float-icon float-4"></ion-icon>
    </div>
  </div>
</ion-content>