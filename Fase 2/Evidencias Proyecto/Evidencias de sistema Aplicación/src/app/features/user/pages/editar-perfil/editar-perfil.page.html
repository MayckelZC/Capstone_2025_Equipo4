<ion-header class="modern-header">
  <ion-toolbar class="gradient-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/user/perfil" class="custom-back-btn"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div class="header-content">
        <ion-icon name="create-outline" class="header-icon"></ion-icon>
        <span>Editar Perfil</span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="saveProfile()" [disabled]="!profileForm.valid || loading" class="save-header-btn">
        <ion-icon name="checkmark-circle-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Actualizando perfil...</p>
  </div>

  <!-- Simple Content -->
  <div class="simple-content">
    <!-- Avatar Section -->
    <div class="avatar-section">
      
      <div class="simple-avatar">
        <ion-avatar class="profile-avatar" *ngIf="croppedImage || previewImage" (click)="selectFile()">
          <img [src]="croppedImage || previewImage" alt="Foto de perfil">
        </ion-avatar>
        
        <ion-avatar class="profile-avatar" *ngIf="!croppedImage && !previewImage" (click)="selectFile()">
          <ion-icon name="person-outline"></ion-icon>
        </ion-avatar>
        
        <ion-button fill="clear" size="small" (click)="selectFile()">
          <ion-icon name="camera-outline" slot="start"></ion-icon>
          Cambiar foto
        </ion-button>
      </div>
    </div>

    <!-- Form Sections -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
      <!-- Photo Section -->
      <div class="form-section photo-section">
        <div class="section-header">
          <ion-icon name="camera-outline" color="primary"></ion-icon>
          <h3>Foto de Perfil</h3>
          <p>Actualiza tu imagen de perfil</p>
        </div>

        <!-- Cropper UI -->
        <div *ngIf="imageChangedEvent && !croppedImage" class="cropper-container">
          <div class="cropper-header">
            <ion-icon name="crop" color="primary"></ion-icon>
            <h4>Ajusta tu foto</h4>
            <p>Arrastra para posicionar y ajustar tu imagen</p>
          </div>
          
          <div class="cropper-wrapper">
            <image-cropper
                [imageChangedEvent]="imageChangedEvent"
                [maintainAspectRatio]="true"
                [aspectRatio]="1 / 1"
                [resizeToWidth]="1024"
                format="jpeg"
                (imageCropped)="imageCropped($event)"
                class="custom-cropper">
            </image-cropper>
          </div>
          
          <div class="cropper-actions">
            <ion-button expand="block" (click)="confirmCrop()" class="confirm-btn">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              Confirmar Foto
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="cancelCrop()" class="cancel-btn">
              <ion-icon name="close-circle" slot="start"></ion-icon>
              Cancelar
            </ion-button>
          </div>
        </div>

        <!-- Photo Actions -->
        <div *ngIf="!imageChangedEvent" class="photo-actions">
          <ion-button fill="outline" (click)="selectFile()" class="photo-btn">
            <ion-icon name="image-outline" slot="start"></ion-icon>
            Elegir de Galería
          </ion-button>
          <ion-button fill="outline" (click)="captureImage()" class="photo-btn">
            <ion-icon name="camera-outline" slot="start"></ion-icon>
            Tomar Foto
          </ion-button>
        </div>
        
        <input type="file" hidden #fileInput (change)="onFileSelected($event)" accept="image/png, image/jpeg">
      </div>

      <!-- Personal Information Section -->
      <div class="form-section personal-section">
        <div class="section-header">
          <ion-icon name="person-outline" color="primary"></ion-icon>
          <h3>Información Personal</h3>
          <p>Datos básicos de tu perfil</p>
        </div>
        
        <div class="form-grid">

          <div class="form-field">
            <ion-item class="modern-item" lines="none">
              <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="stacked">Nombre Completo *</ion-label>
              <ion-input 
                formControlName="nombreCompleto" 
                placeholder="Ej: Juan Carlos Pérez"
                [clearInput]="true"
                class="modern-input">
              </ion-input>
            </ion-item>
            <div class="field-error" *ngIf="profileForm.get('nombreCompleto')?.invalid && profileForm.get('nombreCompleto')?.touched">
              <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
              <span>El nombre completo es requerido</span>
            </div>
          </div>

          <div class="form-field">
            <ion-item class="modern-item" lines="none">
              <ion-icon name="at-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="stacked">Nombre de Usuario *</ion-label>
              <ion-input 
                formControlName="nombreUsuario" 
                placeholder="Ej: juanperez123"
                [clearInput]="true"
                class="modern-input">
              </ion-input>
            </ion-item>
            <div class="field-error" *ngIf="profileForm.get('nombreUsuario')?.invalid && profileForm.get('nombreUsuario')?.touched">
              <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
              <span>El nombre de usuario es requerido</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="form-section contact-section">
        <div class="section-header">
          <ion-icon name="call-outline" color="primary"></ion-icon>
          <h3>Información de Contacto</h3>
          <p>Datos para que otros usuarios te contacten</p>
        </div>
        
        <div class="form-grid">

      <!-- Email Field with Secure Change Option -->
      <div class="email-section">
        <ion-item lines="none" class="email-item">
          <ion-icon name="mail-outline" slot="start"></ion-icon>
          <ion-label position="floating">Email Actual</ion-label>
          <ion-input 
            formControlName="email" 
            type="email" 
            [readonly]="true"
            class="readonly-email">
          </ion-input>
          <ion-button 
            fill="clear" 
            slot="end" 
            (click)="openChangeEmailModal()"
            class="change-email-btn"
            [disabled]="loading">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Cambiar
          </ion-button>
        </ion-item>
        
        <!-- Pending email notification -->
        <div *ngIf="user?.pendingEmail" class="pending-email-notice">
          <ion-icon name="time-outline" color="warning"></ion-icon>
          <span>Cambio pendiente a: <strong>{{ user!.pendingEmail }}</strong></span>
          <ion-button 
            fill="clear" 
            size="small" 
            color="warning"
            (click)="openChangeEmailModal()">
            Ver Estado
          </ion-button>
        </div>
        
        <div class="email-help-text">
          <ion-icon name="information-circle-outline"></ion-icon>
          <span>Por seguridad, el cambio de email requiere verificación</span>
        </div>
      </div>

          <div class="form-field">
            <ion-item class="modern-item" lines="none">
              <ion-icon name="call-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="stacked">Teléfono *</ion-label>
              <ion-input 
                formControlName="telefono" 
                placeholder="Ej: +56 9 1234 5678"
                type="tel"
                [clearInput]="true"
                class="modern-input">
              </ion-input>
            </ion-item>
            <div class="field-error" *ngIf="profileForm.get('telefono')?.invalid && profileForm.get('telefono')?.touched">
              <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
              <span>El teléfono es requerido</span>
            </div>
          </div>

          <div class="form-field">
            <ion-item class="modern-item address-item" lines="none">
              <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="stacked">Dirección</ion-label>
              <ion-input 
                formControlName="direccion" 
                placeholder="Calle y número..."
                [clearInput]="true"
                class="modern-input">
              </ion-input>
            </ion-item>
            <div class="field-error" *ngIf="profileForm.get('direccion')?.invalid && profileForm.get('direccion')?.touched">
              <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
              <span>La dirección es requerida</span>
            </div>
          </div>

          <div class="form-field">
            <ion-item class="modern-item" lines="none">
              <ion-icon name="map-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="stacked">Región</ion-label>
              <ion-input 
                formControlName="region" 
                placeholder="Ej: Metropolitana, Valparaíso..."
                [clearInput]="true"
                class="modern-input">
              </ion-input>
            </ion-item>
          </div>

          <div class="form-field">
            <ion-item class="modern-item" lines="none">
              <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="stacked">Ciudad</ion-label>
              <ion-input 
                formControlName="ciudad" 
                placeholder="Ej: Santiago, Viña del Mar..."
                [clearInput]="true"
                class="modern-input">
              </ion-input>
            </ion-item>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="actions-section">
        <div class="primary-actions">
          <ion-button expand="full" type="submit" [disabled]="!profileForm.valid || loading" class="save-button">
            <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
            <ion-icon *ngIf="!loading" name="save-outline" slot="start"></ion-icon>
            <span *ngIf="!loading">Guardar Cambios</span>
          </ion-button>
        </div>
        
        <div class="secondary-actions">
          <ion-button expand="block" fill="outline" (click)="cancel()" [disabled]="loading" class="cancel-button">
            <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
            Volver al Perfil
          </ion-button>
        </div>
      </div>
    </form>
  </div>
</ion-content>