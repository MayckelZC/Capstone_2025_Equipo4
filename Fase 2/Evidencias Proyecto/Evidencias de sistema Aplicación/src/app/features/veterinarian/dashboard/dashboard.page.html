<ion-header>
  <ion-toolbar color="primary" class="vet-toolbar">
    <ion-buttons slot="start">
      <ion-back-button (click)="goToMenu()"></ion-back-button>
    </ion-buttons>
    <ion-title>Panel Veterinario</ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="notifications-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content pullingText="Desliza para actualizar" refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <ion-grid>
    <!-- SECCIÓN: Métricas Principales -->
    <ion-row>
      <ion-col size="12">
        <h2 class="section-title animate-fade-in">Métricas Principales</h2>
      </ion-col>

      <!-- Tarjeta 1: Citas de Hoy -->
      <ion-col size="12" size-md="6" size-lg="3">
        <ion-card class="dashboard-card today-card interactive-card animate-fade-in-up"
          (click)="selectedSegment = 'today'; segmentChanged({detail: {value: 'today'}})">
          <ion-card-header>
            <ion-card-subtitle>Citas de Hoy</ion-card-subtitle>
            <ion-card-title>{{ todayAppointments.length }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-icon name="calendar-outline"></ion-icon>
            <p class="summary-text">{{ getConfirmedTodayCount() }} confirmadas</p>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <!-- Tarjeta 2: Pendientes de Confirmar -->
      <ion-col size="12" size-md="6" size-lg="3">
        <ion-card class="dashboard-card pending-card interactive-card animate-fade-in-up"
          (click)="selectedSegment = 'pending'; segmentChanged({detail: {value: 'pending'}})"
          style="animation-delay: 0.1s;">
          <ion-card-header>
            <ion-card-subtitle>Pendientes</ion-card-subtitle>
            <ion-card-title>{{ getPendingCount() }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-icon name="time-outline"></ion-icon>
            <p class="summary-text">Requieren confirmación</p>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <!-- Tarjeta 3: Completadas Esta Semana -->
      <ion-col size="12" size-md="6" size-lg="3">
        <ion-card class="dashboard-card completed-card interactive-card animate-fade-in-up"
          (click)="selectedSegment = 'completed'; segmentChanged({detail: {value: 'completed'}})"
          style="animation-delay: 0.2s;">
          <ion-card-header>
            <ion-card-subtitle>Completadas (Semana)</ion-card-subtitle>
            <ion-card-title>{{ getCompletedThisWeekCount() }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-icon name="checkmark-done-outline"></ion-icon>
            <p class="summary-text">Consultas finalizadas</p>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <!-- Tarjeta 4: Próxima Cita -->
      <ion-col size="12" size-md="6" size-lg="3">
        <ion-card class="dashboard-card next-card interactive-card animate-fade-in-up" style="animation-delay: 0.3s;">
          <ion-card-header>
            <ion-card-subtitle>Próxima Cita</ion-card-subtitle>
            <ion-card-title *ngIf="getNextAppointment()">
              {{ getTimeUntilNext(getNextAppointment()) }}
            </ion-card-title>
            <ion-card-title *ngIf="!getNextAppointment()">--</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-icon name="flash-outline"></ion-icon>
            <p class="summary-text" *ngIf="getNextAppointment()">
              {{ getNextAppointment().petName }}
            </p>
            <p class="summary-text" *ngIf="!getNextAppointment()">
              Sin citas programadas
            </p>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- SECCIÓN: Agenda del Día y Acciones Rápidas -->
    <ion-row class="activity-section">
      <ion-col size="12">
        <h2 class="section-title animate-fade-in">Gestión de Citas</h2>
      </ion-col>

      <!-- Filtros de Segmento -->
      <ion-col size="12">
        <ion-segment [(ngModel)]="selectedSegment" (ionChange)="segmentChanged($event)" scrollable>
          <ion-segment-button value="today">
            <ion-label>Hoy</ion-label>
          </ion-segment-button>
          <ion-segment-button value="pending">
            <ion-label>Pendientes</ion-label>
          </ion-segment-button>
          <ion-segment-button value="confirmed">
            <ion-label>Confirmadas</ion-label>
          </ion-segment-button>
          <ion-segment-button value="completed">
            <ion-label>Historial</ion-label>
          </ion-segment-button>
          <ion-segment-button value="all">
            <ion-label>Todas</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-col>

      <!-- Lista de Citas con el diseño actual -->
      <ion-col size="12" size-lg="8">
        <div *ngIf="isLoading" class="loading-container">
          <ion-spinner></ion-spinner>
          <p>Cargando citas...</p>
        </div>

        <div *ngIf="!isLoading && getFilteredAppointments().length === 0" class="empty-state">
          <ion-icon name="calendar-outline" color="medium"></ion-icon>
          <h3>No hay citas</h3>
          <p>No tienes citas {{ selectedSegment === 'today' ? 'para hoy' : 'en esta categoría' }}</p>
        </div>

        <ion-list *ngIf="!isLoading && getFilteredAppointments().length > 0">
          <ion-card *ngFor="let appointment of getFilteredAppointments()" class="appointment-card">
            <ion-card-header>
              <div class="appointment-header">
                <div class="pet-info">
                  <ion-icon name="paw" [color]="getStatusColor(appointment.status)"></ion-icon>
                  <div>
                    <ion-card-title>{{ appointment.petName }}</ion-card-title>
                    <ion-card-subtitle>{{ appointment.userName }}</ion-card-subtitle>
                  </div>
                </div>
                <ion-chip [color]="getStatusColor(appointment.status)">
                  <ion-icon [name]="getStatusIcon(appointment.status)"></ion-icon>
                  <ion-label>{{ appointment.status }}</ion-label>
                </ion-chip>
              </div>
            </ion-card-header>

            <ion-card-content>
              <!-- Appointment Type Badge -->
              <div class="type-badge-container" *ngIf="appointment.appointmentType">
                <ion-chip class="type-badge" [style.--badge-color]="getAppointmentTypeColor(appointment)">
                  <ion-icon [name]="getAppointmentTypeIcon(appointment)"
                    [style.color]="getAppointmentTypeColor(appointment)"></ion-icon>
                  <ion-label>
                    <strong>{{ getAppointmentTypeName(appointment) }}</strong>
                    <span class="duration">{{ getAppointmentDuration(appointment) }} min</span>
                  </ion-label>
                </ion-chip>
              </div>

              <ion-list lines="none">
                <ion-item>
                  <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Fecha</p>
                    <h3>{{ formatDate(appointment.appointmentDate) }}</h3>
                  </ion-label>
                </ion-item>

                <ion-item>
                  <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Hora</p>
                    <h3>{{ appointment.timeSlot }}</h3>
                  </ion-label>
                </ion-item>

                <ion-item>
                  <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Email</p>
                    <h3>{{ appointment.userEmail }}</h3>
                  </ion-label>
                </ion-item>

                <ion-item>
                  <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Motivo</p>
                    <h3>{{ appointment.reason }}</h3>
                  </ion-label>
                </ion-item>
              </ion-list>

              <div class="action-buttons">
                <ion-button *ngIf="appointment.status === 'pendiente'" expand="block"
                  (click)="confirmAppointment(appointment)" color="success">
                  <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                  Confirmar
                </ion-button>

                <ion-button *ngIf="appointment.status === 'confirmada'" expand="block"
                  (click)="completeAppointment(appointment)" color="primary">
                  <ion-icon name="medical" slot="start"></ion-icon>
                  Atender
                </ion-button>

                <ion-button *ngIf="appointment.status === 'completada'" expand="block"
                  (click)="viewAppointmentDetails(appointment)" color="tertiary">
                  <ion-icon name="document-text" slot="start"></ion-icon>
                  Ver Detalles
                </ion-button>

                <ion-button *ngIf="appointment.status === 'pendiente' || appointment.status === 'confirmada'"
                  expand="block" (click)="cancelAppointment(appointment)" fill="outline" color="danger">
                  <ion-icon name="close-circle" slot="start"></ion-icon>
                  Cancelar
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-list>
      </ion-col>

      <!-- Acciones Rápidas -->
      <ion-col size="12" size-lg="4">
        <ion-card class="activity-card glass-card animate-fade-in-up" style="animation-delay: 0.1s;">
          <ion-card-header>
            <ion-card-title>⚡ Acciones Rápidas</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list class="quick-actions-list">
              <ion-item button class="action-item"
                *ngIf="getNextAppointment() && getNextAppointment().status === 'confirmada'"
                (click)="completeAppointment(getNextAppointment())">
                <ion-icon name="medical-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h3>Atender Próxima Cita</h3>
                  <p>{{ getNextAppointment()?.petName }} - {{ getNextAppointment()?.timeSlot }}</p>
                </ion-label>
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-item>

              <ion-item button class="action-item"
                (click)="selectedSegment = 'pending'; segmentChanged({detail: {value: 'pending'}})">
                <ion-icon name="time-outline" slot="start" color="warning"></ion-icon>
                <ion-label>
                  <h3>Ver Pendientes de Confirmar</h3>
                  <p>Citas esperando confirmación</p>
                </ion-label>
                <ion-badge color="warning" slot="end">{{ getPendingCount() }}</ion-badge>
              </ion-item>

              <ion-item button class="action-item"
                (click)="selectedSegment = 'today'; segmentChanged({detail: {value: 'today'}})">
                <ion-icon name="calendar-outline" slot="start" color="success"></ion-icon>
                <ion-label>
                  <h3>Agenda de Hoy</h3>
                  <p>Ver todas las citas programadas</p>
                </ion-label>
                <ion-badge color="primary" slot="end">{{ todayAppointments.length }}</ion-badge>
              </ion-item>

              <ion-item button class="action-item"
                (click)="selectedSegment = 'completed'; segmentChanged({detail: {value: 'completed'}})">
                <ion-icon name="document-text-outline" slot="start" color="tertiary"></ion-icon>
                <ion-label>
                  <h3>Historial de Consultas</h3>
                  <p>Ver citas completadas</p>
                </ion-label>
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>