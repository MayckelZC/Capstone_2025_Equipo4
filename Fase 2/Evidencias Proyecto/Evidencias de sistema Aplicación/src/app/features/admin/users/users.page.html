<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Administrar Usuarios</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="createUser()">
        <ion-icon slot="icon-only" name="person-add-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar>
    <ion-searchbar [(ngModel)]="searchTerm" (ionInput)="applyFiltersAndSort()" showClearButton="always"
      placeholder="Buscar usuarios..."></ion-searchbar>
    <ion-segment [(ngModel)]="currentFilter" (ionChange)="applyFiltersAndSort()">
      <ion-segment-button value="all">
        <ion-label>Todos</ion-label>
      </ion-segment-button>
      <ion-segment-button value="admins">
        <ion-label>Administradores</ion-label>
      </ion-segment-button>
      <ion-segment-button value="blocked">
        <ion-label>Bloqueados</ion-label>
      </ion-segment-button>
    </ion-segment>
    <ion-item lines="none">
      <ion-label>Ordenar por:</ion-label>
      <ion-select [(ngModel)]="currentSort" (ionChange)="applyFiltersAndSort()" interface="popover">
        <ion-select-option value="nameAsc">Nombre (A-Z)</ion-select-option>
        <ion-select-option value="nameDesc">Nombre (Z-A)</ion-select-option>
        <ion-select-option value="emailAsc">Email (A-Z)</ion-select-option>
        <ion-select-option value="emailDesc">Email (Z-A)</ion-select-option>
      </ion-select>
    </ion-item>
  </ion-toolbar>

  <ion-toolbar *ngIf="isMultiSelectActive" color="light">
    <ion-buttons slot="start">
      <ion-button (click)="toggleMultiSelect()">
        <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ countSelectedUsers() }} seleccionados</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="presentBatchActionAlert('block')" [disabled]="countSelectedUsers() === 0">
        <ion-icon slot="icon-only" name="lock-closed-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="presentBatchActionAlert('unblock')" [disabled]="countSelectedUsers() === 0">
        <ion-icon slot="icon-only" name="lock-open-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="presentBatchActionAlert('delete')" [disabled]="countSelectedUsers() === 0">
        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-list *ngIf="filteredUsers.length > 0">
    <ion-card *ngFor="let user of filteredUsers; trackBy: trackByUserId" class="user-card">
      <ion-item (press)="toggleMultiSelect(user.uid)" [class.selected]="isUserSelected(user.uid)"
        [ngClass]="{'user-blocked': user.isBlocked}">
        <ion-checkbox *ngIf="isMultiSelectActive" slot="start" [checked]="isUserSelected(user.uid)"
          (ionChange)="selectUser(user.uid, $event.detail.checked)"></ion-checkbox>
        <ion-avatar slot="start">
          <img [src]="user.profileImageUrl || 'assets/imgs/paw.png'" loading="lazy">
        </ion-avatar>
        <ion-label>
          <h2>
            {{ user.nombreCompleto }}
            <ion-icon name="shield-checkmark" color="primary" *ngIf="user.isAdmin"></ion-icon>
            <ion-icon name="lock-closed" color="danger" *ngIf="user.isBlocked"></ion-icon>
          </h2>
          <p>{{ user.email }}</p>
          <p>Registrado: {{ user.createdAt | date:'dd/MM/yyyy' || 'No disponible' }}</p>
        </ion-label>
      </ion-item>
      <ion-grid class="action-buttons">
        <ion-row>
          <ion-col>
            <ion-button fill="clear" (click)="toggleAdmin(user)" [color]="user.isAdmin ? 'warning' : 'success'">
              <ion-icon slot="icon-only"
                [name]="user.isAdmin ? 'shield-outline' : 'shield-checkmark-outline'"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col>
            <ion-button fill="clear" (click)="toggleBlocked(user)" [color]="user.isBlocked ? 'success' : 'danger'">
              <ion-icon slot="icon-only"
                [name]="user.isBlocked ? 'lock-open-outline' : 'lock-closed-outline'"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col>
            <ion-button fill="clear" color="primary" (click)="editUser(user.uid)">
              <ion-icon slot="icon-only" name="create-outline"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col>
            <ion-button fill="clear" color="danger" (click)="deleteUser(user.uid)">
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card>
  </ion-list>

  <div *ngIf="filteredUsers.length === 0" class="empty-state">
    <ion-icon name="people-circle-outline"></ion-icon>
    <ion-label>No se encontraron usuarios</ion-label>
    <p>Parece que no hay usuarios que coincidan con tu búsqueda. ¡Intenta con otros filtros!</p>
  </div>

  <ion-infinite-scroll (ionInfinite)="loadMore($event)">
    <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando más usuarios...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>
</ion-content>