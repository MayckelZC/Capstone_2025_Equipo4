
<ion-header class="modern-header">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="clearFilters()" [disabled]="!hasActiveFilters()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Limpiar
      </ion-button>
    </ion-buttons>
    <ion-title>
      <div class="header-content">
        <ion-icon name="options-outline"></ion-icon>
        <span>Filtros Inteligentes</span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="dismiss()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Progress Indicator -->
  <div class="filter-progress" *ngIf="hasActiveFilters()">
    <div class="progress-bar" [style.width.%]="getFilterProgress()"></div>
  </div>
</ion-header>

<ion-content class="smart-filters-content">

  <!-- Tamaño Visual -->
  <div class="filter-section">
    <h3 class="section-title">
      <ion-icon name="resize"></ion-icon>
      Tamaño
    </h3>
    
    <div class="size-selector">
      <div 
        class="size-option" 
        [class.active]="isSizeSelected('pequeño')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isSizeSelected('pequeño')"
        (keydown.enter)="toggleSize('pequeño')"
        (keydown.space)="toggleSize('pequeño')"
        (click)="toggleSize('pequeño')">
        <div class="size-icon small">
          <ion-icon name="paw"></ion-icon>
        </div>
        <span>Pequeño</span>
        <small>Hasta 10kg</small>
      </div>
      
      <div 
        class="size-option" 
        [class.active]="isSizeSelected('mediano')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isSizeSelected('mediano')"
        (keydown.enter)="toggleSize('mediano')"
        (keydown.space)="toggleSize('mediano')"
        (click)="toggleSize('mediano')">
        <div class="size-icon medium">
          <ion-icon name="paw"></ion-icon>
        </div>
        <span>Mediano</span>
        <small>10-25kg</small>
      </div>
      
      <div 
        class="size-option" 
        [class.active]="isSizeSelected('grande')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isSizeSelected('grande')"
        (keydown.enter)="toggleSize('grande')"
        (keydown.space)="toggleSize('grande')"
        (click)="toggleSize('grande')">
        <div class="size-icon large">
          <ion-icon name="paw"></ion-icon>
        </div>
        <span>Grande</span>
        <small>Más de 25kg</small>
      </div>
    </div>
  </div>

  <!-- Edad Range Slider -->
  <div class="filter-section">
    <h3 class="section-title">
      <ion-icon name="hourglass"></ion-icon>
      Edad
    </h3>
    
    <div class="age-controls">
      <div class="age-buttons">
        <ion-button 
          fill="outline" 
          size="small"
          [class.active]="filters.etapaVida === 'cachorro'"
          (click)="setAgeStage('cachorro')">
          <ion-icon name="happy" slot="start"></ion-icon>
          Cachorro
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          [class.active]="filters.etapaVida === 'joven'"
          (click)="setAgeStage('joven')">
          <ion-icon name="fitness" slot="start"></ion-icon>
          Joven
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          [class.active]="filters.etapaVida === 'adulto'"
          (click)="setAgeStage('adulto')">
          <ion-icon name="medal" slot="start"></ion-icon>
          Adulto
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          [class.active]="filters.etapaVida === 'senior'"
          (click)="setAgeStage('senior')">
          <ion-icon name="library" slot="start"></ion-icon>
          Senior
        </ion-button>
      </div>
      
      <!-- Custom Age Range -->
      <div class="age-range" *ngIf="showCustomAge">
        <ion-range
          min="0"
          max="15"
          step="0.5"
          snaps="true"
          dual-knobs="true"
          [(ngModel)]="ageRange"
          (ionChange)="onAgeRangeChange($event)">
          <ion-label slot="start">0 años</ion-label>
          <ion-label slot="end">15+ años</ion-label>
        </ion-range>
        <div class="age-display">
          {{ ageRange.lower }} - {{ ageRange.upper }} años
        </div>
      </div>
      
      <ion-button 
        fill="clear" 
        size="small" 
        (click)="toggleCustomAge()">
        {{ showCustomAge ? 'Ocultar' : 'Rango personalizado' }}
      </ion-button>
    </div>
  </div>

  <!-- Género -->
  <div class="filter-section">
    <h3 class="section-title">
      <ion-icon name="male-female"></ion-icon>
      Género
    </h3>
    
    <div class="gender-selector">
      <ion-button 
        fill="outline" 
        [class.active]="filters.sexo === 'macho'"
        (click)="setGender('macho')">
        <ion-icon name="male" slot="start"></ion-icon>
        Macho
      </ion-button>
      
      <ion-button 
        fill="outline" 
        [class.active]="filters.sexo === 'hembra'"
        (click)="setGender('hembra')">
        <ion-icon name="female" slot="start"></ion-icon>
        Hembra
      </ion-button>
    </div>
  </div>

  <!-- Cuidado Médico -->
  <div class="filter-section">
    <h3 class="section-title">
      <ion-icon name="medical"></ion-icon>
      Cuidado Médico
    </h3>
    
    <div class="medical-options">
      <div class="medical-card" [class.active]="filters.esterilizado" role="switch" tabindex="0" [attr.aria-checked]="!!filters.esterilizado" (keydown.enter)="toggleMedical('esterilizado')" (keydown.space)="toggleMedical('esterilizado')" (click)="toggleMedical('esterilizado')">
        <ion-icon name="cut" color="success"></ion-icon>
        <div class="medical-info">
          <span class="title">Esterilizado</span>
          <small>Procedimiento completado</small>
        </div>
        <ion-checkbox [(ngModel)]="filters.esterilizado" (click)="$event.stopPropagation()"></ion-checkbox>
      </div>
      
      <div class="medical-card" [class.active]="filters.vacuna" role="switch" tabindex="0" [attr.aria-checked]="!!filters.vacuna" (keydown.enter)="toggleMedical('vacuna')" (keydown.space)="toggleMedical('vacuna')" (click)="toggleMedical('vacuna')">
        <ion-icon name="shield-checkmark" color="primary"></ion-icon>
        <div class="medical-info">
          <span class="title">Vacunado</span>
          <small>Vacunas al día</small>
        </div>
        <ion-checkbox [(ngModel)]="filters.vacuna" (click)="$event.stopPropagation()"></ion-checkbox>
      </div>
      
      <div class="medical-card" [class.active]="filters.desparasitado" role="switch" tabindex="0" [attr.aria-checked]="!!filters.desparasitado" (keydown.enter)="toggleMedical('desparasitado')" (keydown.space)="toggleMedical('desparasitado')" (click)="toggleMedical('desparasitado')">
        <ion-icon name="bug" color="tertiary"></ion-icon>
        <div class="medical-info">
          <span class="title">Desparasitado</span>
          <small>Libre de parásitos</small>
        </div>
        <ion-checkbox [(ngModel)]="filters.desparasitado" (click)="$event.stopPropagation()"></ion-checkbox>
      </div>
    </div>
  </div>

  <!-- Personalidad Inteligente -->
  <div class="filter-section">
    <h3 class="section-title">
      <ion-icon name="happy"></ion-icon>
      Personalidad y Compatibilidad
    </h3>
    
    <div class="personality-grid">
      <div 
        class="personality-card"
        [class.active]="isPersonalitySelected('bueno con niños')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isPersonalitySelected('bueno con niños')"
        (keydown.enter)="togglePersonality('bueno con niños')"
        (keydown.space)="togglePersonality('bueno con niños')"
        (click)="togglePersonality('bueno con niños')">
        <ion-icon name="people" color="primary"></ion-icon>
        <span>Con niños</span>
      </div>
      
      <div 
        class="personality-card"
        [class.active]="isPersonalitySelected('bueno con otras mascotas')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isPersonalitySelected('bueno con otras mascotas')"
        (keydown.enter)="togglePersonality('bueno con otras mascotas')"
        (keydown.space)="togglePersonality('bueno con otras mascotas')"
        (click)="togglePersonality('bueno con otras mascotas')">
        <ion-icon name="paw" color="success"></ion-icon>
        <span>Con mascotas</span>
      </div>
      
      <div 
        class="personality-card"
        [class.active]="isPersonalitySelected('energético')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isPersonalitySelected('energético')"
        (keydown.enter)="togglePersonality('energético')"
        (keydown.space)="togglePersonality('energético')"
        (click)="togglePersonality('energético')">
        <ion-icon name="flash" color="warning"></ion-icon>
        <span>Energético</span>
      </div>
      
      <div 
        class="personality-card"
        [class.active]="isPersonalitySelected('tranquilo')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isPersonalitySelected('tranquilo')"
        (keydown.enter)="togglePersonality('tranquilo')"
        (keydown.space)="togglePersonality('tranquilo')"
        (click)="togglePersonality('tranquilo')">
        <ion-icon name="leaf" color="medium"></ion-icon>
        <span>Tranquilo</span>
      </div>
      
      <div 
        class="personality-card"
        [class.active]="isPersonalitySelected('entrenado en casa')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isPersonalitySelected('entrenado en casa')"
        (keydown.enter)="togglePersonality('entrenado en casa')"
        (keydown.space)="togglePersonality('entrenado en casa')"
        (click)="togglePersonality('entrenado en casa')">
        <ion-icon name="home" color="success"></ion-icon>
        <span>Educado</span>
      </div>
      
      <div 
        class="personality-card"
        [class.active]="isPersonalitySelected('guardián')"
        role="checkbox"
        tabindex="0"
        [attr.aria-checked]="isPersonalitySelected('guardián')"
        (keydown.enter)="togglePersonality('guardián')"
        (keydown.space)="togglePersonality('guardián')"
        (click)="togglePersonality('guardián')">
        <ion-icon name="shield" color="danger"></ion-icon>
        <span>Guardián</span>
      </div>
    </div>
  </div>

  <!-- Filtros Guardados -->
  <div class="filter-section" *ngIf="savedFilters.length > 0">
    <h3 class="section-title">
      <ion-icon name="bookmark"></ion-icon>
      Filtros Guardados
    </h3>
    
    <div class="saved-filters">
      <ion-chip 
        *ngFor="let saved of savedFilters"
        (click)="loadSavedFilter(saved)"
        color="secondary">
        <ion-icon name="bookmark"></ion-icon>
        <ion-label>{{ saved.name }}</ion-label>
        <ion-icon name="close-circle" (click)="deleteSavedFilter(saved.id); $event.stopPropagation()"></ion-icon>
      </ion-chip>
    </div>
  </div>

  <!-- Results Preview -->
  <div class="results-preview" *ngIf="hasActiveFilters()" aria-live="polite">
    <div class="preview-content">
      <ion-icon name="search" color="primary"></ion-icon>
      <span>Estimación: <strong>{{ estimatedResults }}</strong> mascotas</span>
    </div>
  </div>
</ion-content>

<!-- Action Buttons -->
<ion-footer>
  <div class="filter-actions">
    <ion-button 
      fill="solid"
      color="primary"
      expand="block"
      (click)="applyFilters()"
      class="apply-button">
      <ion-icon name="checkmark" slot="start"></ion-icon>
      Aplicar Filtros ({{ estimatedResults }})
    </ion-button>
  </div>
</ion-footer>
