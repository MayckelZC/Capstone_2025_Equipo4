<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/misadopciones"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <ion-icon name="mail-outline" class="header-icon"></ion-icon>
      Solicitudes para {{ filteredRequests[0]?.pet?.name || 'esta mascota' }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="viewPetDetails()" fill="clear">
        <ion-icon name="paw-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="refreshRequests()" fill="clear">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando solicitudes...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading">
    <!-- Statistics Cards -->
    <div class="stats-container">
      <div class="stats-grid">
        <div class="stat-card">
          <ion-icon name="mail-outline" class="stat-icon green"></ion-icon>
          <div class="stat-info">
            <span class="stat-number">{{ stats.total }}</span>
            <span class="stat-label">TOTAL</span>
          </div>
        </div>

        <div class="stat-card">
          <ion-icon name="time-outline" class="stat-icon green"></ion-icon>
          <div class="stat-info">
            <span class="stat-number">{{ stats.pending }}</span>
            <span class="stat-label">PENDIENTES</span>
          </div>
        </div>

        <div class="stat-card">
          <ion-icon name="checkmark-circle-outline" class="stat-icon green"></ion-icon>
          <div class="stat-info">
            <span class="stat-number">{{ stats.approved }}</span>
            <span class="stat-label">APROBADAS</span>
          </div>
        </div>

        <div class="stat-card">
          <ion-icon name="close-circle-outline" class="stat-icon green"></ion-icon>
          <div class="stat-info">
            <span class="stat-number">{{ stats.rejected }}</span>
            <span class="stat-label">RECHAZADAS</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-container">
      <!-- Barra de búsqueda -->
      <div class="search-section">
        <ion-searchbar [(ngModel)]="searchTerm" (ionInput)="onFilterChange()" placeholder="Buscar por solicitante..."
          show-clear-button="focus">
        </ion-searchbar>
      </div>

      <!-- Filtro de estado -->
      <div class="filter-dropdowns">
        <ion-select [(ngModel)]="selectedStatus" (ionChange)="onFilterChange()" placeholder="Todos los estados"
          interface="popover" class="filter-select">
          <ion-select-option value="all">Todos los estados</ion-select-option>
          <ion-select-option value="pending">Pendientes</ion-select-option>
          <ion-select-option value="approved">Aprobadas</ion-select-option>
          <ion-select-option value="rejected">Rechazadas</ion-select-option>
        </ion-select>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="requests.length === 0" class="empty-state">
      <ion-icon name="mail-open-outline" class="empty-icon"></ion-icon>
      <h2>No hay solicitudes</h2>
      <p>Aún no has recibido solicitudes para esta mascota.</p>
      <ion-button routerLink="/adoptions/my-adoptions" fill="outline" color="primary">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Volver a Mis Publicaciones
      </ion-button>
    </div>

    <!-- No filtered results -->
    <div *ngIf="requests.length > 0 && filteredRequests.length === 0" class="empty-state">
      <ion-icon name="search-outline" class="empty-icon"></ion-icon>
      <h2>Sin resultados</h2>
      <p>No se encontraron solicitudes con los filtros aplicados.</p>
      <ion-button fill="clear" (click)="selectedStatus = 'all'; searchTerm = ''; onFilterChange()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Limpiar filtros
      </ion-button>
    </div>

    <!-- Request Cards -->
    <div *ngIf="filteredRequests.length > 0" class="requests-list">
      <div *ngFor="let request of filteredRequests; trackBy: trackByRequestId" class="request-card-modern">

        <!-- Card Header -->
        <div class="card-header">
          <div class="avatar-section">
            <div class="avatar-container clickable" (click)="viewApplicantProfile(request)">
              <img [src]="request.applicant?.profileImageUrl || 'assets/imgs/paw.png'" [alt]="request.applicantName"
                class="avatar-image" (error)="$any($event.target).src='assets/imgs/paw.png'" />
            </div>
            <div class="requester-info">
              <h3 class="requester-name clickable" (click)="viewApplicantProfile(request)">{{ request.applicantName }}
              </h3>
              <p class="solicitud-info">
                Solicitud: {{ formatRequestDate(request.requestDate) }}
              </p>
            </div>
          </div>

          <div class="status-badge">
            <ion-chip [color]="getStatusColor(request.status)" class="status-chip-modern">
              <ion-label>{{ getStatusText(request.status) }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- Pet Info -->
        <div class="pet-info-section">
          <div class="pet-image-container">
            <img [src]="request.pet?.imageUrl || 'assets/imgs/paw.png'" [alt]="request.pet?.name" class="pet-image"
              (error)="$any($event.target).src='assets/imgs/paw.png'" />
          </div>
          <div class="pet-details">
            <h4 class="pet-name">{{ request.pet?.name }}</h4>
            <p class="pet-type">{{ request.pet?.type }} {{ request.pet?.breed ? '• ' + request.pet?.breed : '' }}</p>
          </div>
        </div>

        <!-- Housing Info Tags -->
        <div class="housing-tags">
          <div class="tag" *ngIf="request.housingType">
            <ion-icon name="home-outline"></ion-icon>
            <span>{{ request.housingType === 'own' ? 'Casa Propia' : 'Casa Alquilada' }}</span>
          </div>
          <div class="tag" *ngIf="request.previousExperience !== undefined">
            <ion-icon name="school-outline"></ion-icon>
            <span>{{ request.previousExperience ? 'Con Experiencia' : 'Sin Experiencia' }}</span>
          </div>
          <div class="tag" *ngIf="request.otherPets !== undefined">
            <ion-icon name="paw-outline"></ion-icon>
            <span>{{ request.otherPets ? 'Tiene Otras Mascotas' : 'Sin Otras Mascotas' }}</span>
          </div>
          <div class="tag tag-success" *ngIf="request.commitmentPdfUrl">
            <ion-icon name="shield-checkmark-outline"></ion-icon>
            <span>Compromiso Firmado</span>
          </div>
        </div>

        <!-- Attention Points -->
        <div class="attention-points" *ngIf="getRedFlags(request).length > 0">
          <div class="attention-header">
            <ion-icon name="warning-outline"></ion-icon>
            <span>Puntos de Atención:</span>
          </div>
          <ul class="attention-list">
            <li *ngFor="let flag of getRedFlags(request)">{{ flag }}</li>
          </ul>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons-row">
          <ion-button fill="clear" size="default" color="primary" (click)="viewQuestionnaire(request)"
            class="action-btn">
            <ion-icon name="document-text-outline" slot="start"></ion-icon>
            CUESTIONARIO
          </ion-button>

          <ion-button fill="clear" size="default" color="tertiary" (click)="viewCommitmentDocument(request)"
            class="action-btn" *ngIf="request.commitmentPdfUrl">
            <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
            COMPROMISO
          </ion-button>

          <!-- Chat button hidden - using direct contact methods instead -->
        </div>

        <!-- Warning if no commitment document -->
        <div class="document-warning" *ngIf="!request.commitmentPdfUrl">
          <ion-icon name="information-circle-outline" color="warning"></ion-icon>
          <span>Documento de compromiso no disponible</span>
        </div>

        <!-- Contact Methods Row -->
        <div class="contact-methods-row">
          <ion-button fill="outline" size="small" [href]="getWhatsAppLink(request.applicant?.telefono!)" target="_blank"
            color="success" class="contact-btn" *ngIf="request.applicant?.telefono">
            <ion-icon name="logo-whatsapp" slot="start"></ion-icon>
            WhatsApp
          </ion-button>

          <ion-button fill="outline" size="small" [href]="'tel:' + request.applicant?.telefono" color="primary"
            class="contact-btn" *ngIf="request.applicant?.telefono">
            <ion-icon name="call" slot="start"></ion-icon>
            Llamar
          </ion-button>

          <ion-button fill="outline" size="small" [href]="'mailto:' + request.applicant?.email" color="tertiary"
            class="contact-btn" *ngIf="request.applicant?.email">
            <ion-icon name="mail" slot="start"></ion-icon>
            Email
          </ion-button>
        </div>

        <!-- Decision Buttons -->
        <div class="decision-buttons" *ngIf="request.status === 'pending'">
          <ion-button expand="block" fill="solid" color="success" size="default" (click)="approve(request)"
            class="decision-btn approve-btn">
            APROBAR SOLICITUD
          </ion-button>

          <ion-button expand="block" fill="solid" color="danger" size="default" (click)="reject(request)"
            class="decision-btn reject-btn">
            RECHAZAR SOLICITUD
          </ion-button>
        </div>

        <!-- Delivery Confirmation Section (For Approved Requests) -->
        <div class="delivery-confirmation-section" *ngIf="request.status === 'approved'">
          <div class="delivery-status-info">
            <h4>Estado de Confirmación de Entrega</h4>
            <div class="confirmation-grid">
              <div class="confirmation-item" [class.confirmed]="request.ownerDeliveryConfirmedAt">
                <ion-icon [name]="request.ownerDeliveryConfirmedAt ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                <span>Publicador {{ request.ownerDeliveryConfirmedAt ? 'confirmó' : 'pendiente' }}</span>
                <small *ngIf="request.ownerDeliveryConfirmedAt">{{ request.ownerDeliveryConfirmedAt | date:'short'
                  }}</small>
              </div>
              <div class="confirmation-item" [class.confirmed]="request.adopterDeliveryConfirmedAt">
                <ion-icon
                  [name]="request.adopterDeliveryConfirmedAt ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                <span>Adoptante {{ request.adopterDeliveryConfirmedAt ? 'confirmó' : 'pendiente' }}</span>
                <small *ngIf="request.adopterDeliveryConfirmedAt">{{ request.adopterDeliveryConfirmedAt | date:'short'
                  }}</small>
              </div>
            </div>
          </div>

          <ion-button expand="block" fill="solid" color="tertiary" size="default"
            (click)="confirmDeliveryAsOwner(request)" class="confirm-delivery-btn"
            *ngIf="!request.ownerDeliveryConfirmedAt">
            <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
            CONFIRMAR ENTREGA (PUBLICADOR)
          </ion-button>

          <div class="delivery-confirmed-message" *ngIf="request.ownerDeliveryConfirmedAt">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
            <p>Has confirmado la entrega. Esperando confirmación del adoptante.</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshRequests($event)">
    <ion-refresher-content pullingIcon="chevron-down-circle-outline" pullingText="Desliza para actualizar"
      refreshingSpinner="circles" refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>
</ion-content>